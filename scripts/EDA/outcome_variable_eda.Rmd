---
title: "Bipolar Disorder & Suicidality Outcome Variable EDA"
author: "Sam A. Sievertsen"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: true
---

```{r global, include = FALSE}

# Set global env variables
knitr::opts_chunk$set(warning = FALSE, message = FALSE, comment = "")

```

# Exploratory Data Analysis (EDA) of variables to be used as outcome metrics related to mood disorders and suicidality in the ABCD dataset

The most up to date list of variables to used as outcomes in the current study, including their role, domain, details of each variable as it relates to the ABCD dataset, etc., can be [found here](https://ohsuitg-my.sharepoint.com/:x:/r/personal/sievertsen_ohsu_edu/Documents/Huber_Lab/FYP/Project_Planning/ABCD_Mood_Disorder_Risk_Model_Variables_010624_SS.xlsx?d=w286583f8914b4ab5a402e36ce8c36291&csf=1&web=1&e=ieCAKt&nav=MTVfezIxMDEwOEMxLTFFMjktNERDMi1CQTE4LTM0QTE2NzA0MEQ2RX0). 

The following report contains information regarding the: 

  1. Integrity of the data
  
  2. Assessment of outliers in the data
  
  3. Skewness + appropriateness of the mean as the measure of central tendency for continuous variables
  
  4. Shape of each variables' distribution
  
  5. Distribution of Past-Only vs. Current Diagnoses by Timepoint
  
  6. Transitions: Who “Drops Out” vs. Who “Converts In” at Adjacent Timepoints
  
  7. Transitions Between Diagnostic Sub-Categories
  
  8. Tiered Bipolar‐Spectrum Definitions & Their Stability
  
  9. Clarifying Bipolar NOS Diagnoses
  
  10. Operationalization of Outcome Variables

```{r environment, echo = FALSE, include = FALSE, warning = FALSE}

# Load necessary packages + environmental variables
library(knitr)
library(kableExtra)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(tidytext)
library(networkD3)
library(patchwork)
library(purrr)
library(htmltools)
library(moments)
options(scipen = 999, digits = 8)

# Read in raw data generated in DEAP
raw_data <- read.csv("../../data/data_raw/dataset.csv")

```

## Data Wrangling 

This section prepares the data for EDA of outcomes via the following process:

| Step | Purpose |
|------|---------|
| **1 - Define raw KSADS™ columns** | For every outcome (passive/active suicidal ideation, suicide attempt, NSSI, Bipolar I, Bipolar II, Any-BSD) we list all relevant parent- and youth-report “current” and “past” diagnostic flags. |
| **2 - Create binary variables** | Using `dplyr::case_when()` we mark a variable as 1 if any constituent flag = 1, 0 if at least one flag = 0 but none are 1, and NA only when every constituent column is missing. guarantees NA only when true data absence, not when zeros are present |
| **3 - Define depression qualifiers** | Collect all parent + youth Major Depressive Disorder and Persistent Depressive Disorder (current, past, partial-remission) flags |
| **4 - Identify “past mania/hypomania only” flags** | `bd1_past_mania_vars` (BD-I recent past manic) and `bd2_past_mania_vars` (BD-II recent past hypomanic) |
| **5 - Rescore Bipolar I & II at baseline (ses-00A) and 2-year (ses-02A)** | If a row shows past manic/hypomanic episode and the youth has any depressive-disorder flag → keep diagnosis = 1. If past manic/hypomanic but no depression history → force diagnosis = 0. All other rows (different sessions or current episodes) keep their original value |

**Why we rescore Bipolar I/II “past episode manic/hypomanic” flags**
      
The ABCD Study’s KSADS-COMP v1.0 over-diagnoses Lifetime Bipolar-I by allowing a *single* past manic flag to qualify. [Barch et al. (2021)](https://doi.org/10.1016/j.dcn.2021.101031) note:
      
      > “The computerized KSADS 1.0 shows **higher than expected rates** of caregiver- and youth-reported *past manic episodes* (e.g., caregiver-reported prevalence of Bipolar I Disorder, most recent past episode manic is 2.6%). We recommend rescoring such cases so that the youth must also meet criteria for a current or past depressive disorder to satisfy diagnostic criteria.”
    
Following this recommendation we:
      
  - restrict rescoring to baseline and 2-year follow-up waves (those using KSADS-v1 past-episode items);

  - require any lifetime MDD/PDD flag alongside past mania/hypomania before endorsing Bipolar I or II.
    
This likely yields more realistic prevalence estimates while keeping current-episode diagnoses intact and preserving the longitudinal structure needed for survival and mixed-effects models.

```{r data wrangling, echo = FALSE, include = FALSE, warning = FALSE}

## Data Wrangling ##

#1. Clean the outcome data 
#1.1 Clean the KSADS-COMP Diagnosis Data
#1.11 Retain only columns of interest
raw_data_trimmed <- raw_data %>% 
  dplyr::select(c(participant_id, session_id, mh_p_ksads__suic__pass__past_dx, mh_p_ksads__suic__actv__past_dx, mh_p_ksads__suic__actv__mthd__past_dx, mh_p_ksads__suic__actv__int__past_dx, mh_p_ksads__suic__actv__plan__past_dx, mh_p_ksads__suic__pass__pres_dx, mh_p_ksads__suic__actv__pres_dx, mh_p_ksads__suic__actv__mthd__pres_dx, mh_p_ksads__suic__actv__int__pres_dx, mh_p_ksads__suic__actv__plan__pres_dx, mh_y_ksads__suic__pass__past_dx, mh_y_ksads__suic__actv__past_dx, mh_y_ksads__suic__actv__mthd__past_dx, mh_y_ksads__suic__actv__int__past_dx, mh_y_ksads__suic__actv__plan__past_dx, mh_y_ksads__suic__pass__pres_dx, mh_y_ksads__suic__actv__pres_dx, mh_y_ksads__suic__actv__mthd__pres_dx, mh_y_ksads__suic__actv__int__pres_dx, mh_y_ksads__suic__actv__plan__pres_dx, mh_p_ksads__suic__atmpt__intr__past_dx, mh_p_ksads__suic__atmpt__abrt__past_dx, mh_p_ksads__suic__atmpt__past_dx, mh_p_ksads__suic__atmpt__intr__pres_dx, mh_p_ksads__suic__atmpt__abrt__pres_dx, mh_p_ksads__suic__atmpt__pres_dx, mh_y_ksads__suic__atmpt__intr__past_dx, mh_y_ksads__suic__atmpt__abrt__past_dx, mh_y_ksads__suic__atmpt__past_dx, mh_y_ksads__suic__atmpt__intr__pres_dx, mh_y_ksads__suic__atmpt__abrt__pres_dx, mh_y_ksads__suic__atmpt__pres_dx, mh_p_ksads__suic__slfinj__nosi__pres_dx, mh_p_ksads__suic__slfinj__nosi__past_dx, mh_y_ksads__suic__slfinj__nosi__pres_dx, mh_y_ksads__suic__slfinj__nosi__past_dx, mh_p_ksads__bpd__bpd1__curdep__partrem_dx, mh_p_ksads__bpd__bpd1__rcnt__manicmix__pres_dx, mh_p_ksads__bpd__bpd1__curmanic__pres_dx, mh_p_ksads__bpd__bpd1__curdep__pres_dx, mh_y_ksads__bpd__bpd1__curmanic__pres_dx, mh_y_ksads__bpd__bpd1__curdep__pres_dx, mh_y_ksads__bpd__bpd1__rcnt__manic__pres_dx, mh_p_ksads__bpd__bpd1__curhypo__pres_dx, mh_p_ksads__bpd__bpd1__rcnt__dep__pres_dx, mh_p_ksads__bpd__bpd1__rcnt__manic__pres_dx, mh_y_ksads__bpd__bpd1__rcnt__dep__pres_dx, mh_y_ksads__bpd__bpd1__curhypo__pres_dx, mh_y_ksads__bpd__bpd1__rcnt__manicmix__pres_dx, mh_y_ksads__bpd__bpd1__curdep__partrem_dx, mh_p_ksads__bpd__bpd2__curhypo__pres_dx, mh_p_ksads__bpd__bpd2__rcnt__hypo__pres_dx, mh_p_ksads__bpd__bpd2__curdep__pres_dx, mh_p_ksads__bpd__bpd2__curdep__partrem_dx, mh_y_ksads__bpd__bpd2__curdep__pres_dx, mh_y_ksads__bpd__bpd2__curdep__partrem_dx, mh_y_ksads__bpd__bpd2__rcnt__hypo__pres_dx, mh_y_ksads__bpd__bpd2__curhypo__pres_dx, mh_p_ksads__bpd__bpd2__rcnt__hypomix__pres_dx, mh_y_ksads__bpd__bpd2__rcnt__hypomix__pres_dx, mh_p_ksads__bpd__bpd2__oth__mindur_dx, mh_p_ksads__bpd__oth__mindur_dx, mh_y_ksads__bpd__bpd2__oth__mindur_dx, mh_y_ksads__bpd__oth__mindur_dx, mh_p_ksads__bpd__unspec__pres_dx, mh_p_ksads__bpd__unspec__past_dx, mh_y_ksads__bpd__unspec__pres_dx, mh_y_ksads__bpd__unspec__past_dx, mh_p_ksads__dep__mdd__partrem_dx, mh_p_ksads__dep__mdd__past_dx, mh_p_ksads__dep__mdd__pres_dx, mh_p_ksads__dep__pdd__oth__pres_dx, mh_p_ksads__dep__pdd__partrem_dx, mh_p_ksads__dep__pdd__past_dx, mh_p_ksads__dep__pdd__pres_dx, mh_y_ksads__dep__mdd__partrem_dx, mh_y_ksads__dep__mdd__past_dx, mh_y_ksads__dep__mdd__pres_dx, mh_y_ksads__dep__pdd__oth__pres_dx, mh_y_ksads__dep__pdd__partrem_dx, mh_y_ksads__dep__pdd__past_dx, mh_y_ksads__dep__pdd__pres_dx, mh_p_cbcl__dsm__dep_tscore, mh_p_cbcl__dsm__dep_nm, mh_p_cbcl__dsm__anx_tscore, mh_p_cbcl__dsm__anx_nm, mh_p_cbcl__synd__attn_tscore, mh_p_cbcl__synd__attn_nm, mh_p_cbcl__synd__aggr_tscore, mh_p_cbcl__synd__aggr_nm, mh_p_gbi_sum))

#1.12 Turn all instances of empty, missing, 555, and 999 to NA; and 888 to 0 in KSADS columns
raw_data_trimmed <- raw_data_trimmed %>%
  mutate(across(starts_with("mh_") & contains("ksads"),
    ~ case_when(. == 888 ~ 0, . %in% c(555, 999, "") | is.na(.) ~ NA, TRUE ~ .)))

#1.2 Clean the Continuous CBCL Outcomes of Interest
raw_data_trimmed <- raw_data_trimmed %>% 
  mutate(
    
    #1.21 Remove any depression t scores created with missing values
    mh_p_cbcl__dsm__dep_tscore = if_else(mh_p_cbcl__dsm__dep_nm >= 1, NA_real_, mh_p_cbcl__dsm__dep_tscore),
    
    #1.22 Remove any anxiety t scores created with missing values
    mh_p_cbcl__dsm__anx_tscore = if_else(mh_p_cbcl__dsm__anx_nm >= 1, NA_real_, mh_p_cbcl__dsm__anx_tscore), 
    
    #1.23 Remove any attention t scores created with missing values
    mh_p_cbcl__synd__attn_tscore = if_else(mh_p_cbcl__synd__attn_nm >= 1, NA_real_, mh_p_cbcl__synd__attn_tscore),
    
    #1.24 Remove any aggression t scores created with missing values
    mh_p_cbcl__synd__aggr_tscore = if_else(mh_p_cbcl__synd__aggr_nm >= 1, NA_real_, mh_p_cbcl__synd__aggr_tscore))

#2. Preliminarily create relevant outcome variables of interest
#2.1 Define KSADS-COMP columns for each outcome
#2.1.1 Suicidal Ideation - passive (past or present; parent or youth report)
si_passive_vars <- c(
  "mh_p_ksads__suic__pass__past_dx",
  "mh_p_ksads__suic__pass__pres_dx",
  "mh_y_ksads__suic__pass__past_dx",
  "mh_y_ksads__suic__pass__pres_dx"
)

#2.1.2 Suicidal Ideation - active (all subtypes; past or present; parent or youth)
si_active_vars <- c(
  "mh_p_ksads__suic__actv__past_dx",
  "mh_p_ksads__suic__actv__mthd__past_dx",
  "mh_p_ksads__suic__actv__int__past_dx",
  "mh_p_ksads__suic__actv__plan__past_dx",
  "mh_p_ksads__suic__actv__pres_dx",
  "mh_p_ksads__suic__actv__mthd__pres_dx",
  "mh_p_ksads__suic__actv__int__pres_dx",
  "mh_p_ksads__suic__actv__plan__pres_dx",
  "mh_y_ksads__suic__actv__past_dx",
  "mh_y_ksads__suic__actv__mthd__past_dx",
  "mh_y_ksads__suic__actv__int__past_dx",
  "mh_y_ksads__suic__actv__plan__past_dx",
  "mh_y_ksads__suic__actv__pres_dx",
  "mh_y_ksads__suic__actv__mthd__pres_dx",
  "mh_y_ksads__suic__actv__int__pres_dx",
  "mh_y_ksads__suic__actv__plan__pres_dx"
)

#2.1.3 Suicide Attempt - interrupted, aborted, or completed (past or present; parent or youth)
sa_vars <- c(
  "mh_p_ksads__suic__atmpt__intr__past_dx",
  "mh_p_ksads__suic__atmpt__abrt__past_dx",
  "mh_p_ksads__suic__atmpt__past_dx",
  "mh_p_ksads__suic__atmpt__intr__pres_dx",
  "mh_p_ksads__suic__atmpt__abrt__pres_dx",
  "mh_p_ksads__suic__atmpt__pres_dx",
  "mh_y_ksads__suic__atmpt__intr__past_dx",
  "mh_y_ksads__suic__atmpt__abrt__past_dx",
  "mh_y_ksads__suic__atmpt__past_dx",
  "mh_y_ksads__suic__atmpt__intr__pres_dx",
  "mh_y_ksads__suic__atmpt__abrt__pres_dx",
  "mh_y_ksads__suic__atmpt__pres_dx"
)

#2.1.4 Non-Suicidal Self-Injury (NSSI; past or present; parent or youth)
nssi_vars <- c(
  "mh_p_ksads__suic__slfinj__nosi__pres_dx",
  "mh_p_ksads__suic__slfinj__nosi__past_dx",
  "mh_y_ksads__suic__slfinj__nosi__pres_dx",
  "mh_y_ksads__suic__slfinj__nosi__past_dx"
)

#2.1.5 Bipolar I Disorder - any current or recent past episode (parent or youth)
bd1_vars <- c(
  "mh_p_ksads__bpd__bpd1__curdep__partrem_dx",
  "mh_p_ksads__bpd__bpd1__rcnt__manicmix__pres_dx",
  "mh_p_ksads__bpd__bpd1__curmanic__pres_dx",
  "mh_p_ksads__bpd__bpd1__curdep__pres_dx",
  "mh_y_ksads__bpd__bpd1__curmanic__pres_dx",
  "mh_y_ksads__bpd__bpd1__curdep__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__manic__pres_dx",
  "mh_p_ksads__bpd__bpd1__curhypo__pres_dx",
  "mh_p_ksads__bpd__bpd1__rcnt__dep__pres_dx",
  "mh_p_ksads__bpd__bpd1__rcnt__manic__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__dep__pres_dx",
  "mh_y_ksads__bpd__bpd1__curhypo__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__manicmix__pres_dx",
  "mh_y_ksads__bpd__bpd1__curdep__partrem_dx"
)

#2.1.6 Bipolar II Disorder - any current or recent past hypomanic/depressive episode (parent or youth)
bd2_vars <- c(
  "mh_p_ksads__bpd__bpd2__curhypo__pres_dx",
  "mh_p_ksads__bpd__bpd2__rcnt__hypo__pres_dx",
  "mh_p_ksads__bpd__bpd2__curdep__pres_dx",
  "mh_p_ksads__bpd__bpd2__curdep__partrem_dx",
  "mh_y_ksads__bpd__bpd2__curdep__pres_dx",
  "mh_y_ksads__bpd__bpd2__curdep__partrem_dx",
  "mh_y_ksads__bpd__bpd2__rcnt__hypo__pres_dx",
  "mh_y_ksads__bpd__bpd2__curhypo__pres_dx",
  "mh_p_ksads__bpd__bpd2__rcnt__hypomix__pres_dx",
  "mh_y_ksads__bpd__bpd2__rcnt__hypomix__pres_dx"
)

#2.1.7 Any Bipolar Disorder - combine Bipolar I, II, OS & unspecified (parent or youth)
unspec_vars <- c(
  "mh_p_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_p_ksads__bpd__oth__mindur_dx",
  "mh_y_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_y_ksads__bpd__oth__mindur_dx",
  "mh_p_ksads__bpd__unspec__pres_dx",
  "mh_p_ksads__bpd__unspec__past_dx",
  "mh_y_ksads__bpd__unspec__pres_dx",
  "mh_y_ksads__bpd__unspec__past_dx")

# 2.1.8 Depression qualifiers for rescoring bipolar past mania/hypomania
dep_vars <- c(
  "mh_p_ksads__dep__mdd__partrem_dx",
  "mh_p_ksads__dep__mdd__past_dx",
  "mh_p_ksads__dep__mdd__pres_dx",
  "mh_y_ksads__dep__mdd__partrem_dx",
  "mh_y_ksads__dep__mdd__past_dx",
  "mh_y_ksads__dep__mdd__pres_dx",
  "mh_p_ksads__dep__pdd__oth__pres_dx",
  "mh_p_ksads__dep__pdd__partrem_dx",
  "mh_p_ksads__dep__pdd__past_dx",
  "mh_p_ksads__dep__pdd__pres_dx",
  "mh_y_ksads__dep__pdd__oth__pres_dx",
  "mh_y_ksads__dep__pdd__partrem_dx",
  "mh_y_ksads__dep__pdd__past_dx",
  "mh_y_ksads__dep__pdd__pres_dx"
)

#2.1.9 Bipolar I past mania vars for rescoring
bd1_past_mania_vars <- c(
  "mh_p_ksads__bpd__bpd1__rcnt__manic__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__manic__pres_dx"
)

#2.1.10 Bipolar II past hypomania vars for rescoring
bd2_past_mania_vars <- c(
  "mh_p_ksads__bpd__bpd2__rcnt__hypo__pres_dx",
  "mh_y_ksads__bpd__bpd2__rcnt__hypo__pres_dx"
)

#2.2 Create binary outcomes including any necessary validation steps
prelim_outcome_data <- raw_data_trimmed %>%
  mutate(
    
    #2.2.1 Suicidal ideation - passive
    si_passive = case_when(
      rowSums(dplyr::select(., all_of(si_passive_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(si_passive_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.2 Suicidal ideation - active
    si_active = case_when(
      rowSums(dplyr::select(., all_of(si_active_vars))  == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(si_active_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.3 Suicide Attempt
    sa = case_when(
      rowSums(dplyr::select(., all_of(sa_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(sa_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.4 Non-Suicidal Self-Injury (NSSI)
    nssi = case_when(
      rowSums(dplyr::select(., all_of(nssi_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(nssi_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.5 Bipolar I Disorder
    bipolar_I = case_when(
      rowSums(dplyr::select(., all_of(bd1_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(bd1_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.6 Bipolar II Disorder
    bipolar_II = case_when(
      rowSums(dplyr::select(., all_of(bd2_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      rowSums(!is.na(dplyr::select(., all_of(bd2_vars)))) == 0 ~ NA_real_,
      TRUE ~ 0),
    
    #2.2.7 Rescore Bipolar I at baseline & 2-year: past mania requires depression
    bipolar_I = case_when(
      session_id %in% c("ses-00A","ses-02A") &
        rowSums(dplyr::select(., all_of(bd1_past_mania_vars)) == 1, na.rm = TRUE) > 0 ~
          if_else(rowSums(dplyr::select(., all_of(dep_vars)) == 1, na.rm = TRUE) > 0, 1, 0),
      TRUE ~ bipolar_I),
    
    #2.2.8 Rescore Bipolar II at baseline & 2-year: past hypomania requires depression
    bipolar_II = case_when(
      session_id %in% c("ses-00A","ses-02A") &
        rowSums(dplyr::select(., all_of(bd2_past_mania_vars)) == 1, na.rm = TRUE) > 0 ~
          if_else(rowSums(dplyr::select(., all_of(dep_vars)) == 1, na.rm = TRUE) > 0, 1, 0),
      TRUE ~ bipolar_II),
    
    #2.2.9 Any Bipolar Spectrum Disorder
    any_bsd = case_when(
      
      #2.2.9.1 if either validated BD-I or BD-II flag is 1, count as BSD
      bipolar_I  == 1 | bipolar_II == 1 ~ 1,
      
      #2.2.9.2 else if *any* of the OS/unspecified vars is present, count as BSD
      rowSums(select(., all_of(unspec_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      
      #2.2.9.3 if none of the BD1, BD2 or NS vars were ever measured → NA
      rowSums(!is.na(select(., all_of(c(bd1_vars, bd2_vars, unspec_vars))))) == 0 ~ NA_real_,
      
      #2.2.9.4 otherwise explicitly no BSD
      TRUE ~ 0)
  )

#2.3 Retain only the columns of interest to EDA of outcome data
prelim_outcome_data_trimmed <- prelim_outcome_data %>% 
  dplyr::select(c(participant_id, session_id, si_passive, si_active, sa, nssi, bipolar_I, bipolar_II, any_bsd, mh_p_cbcl__dsm__dep_tscore, mh_p_cbcl__dsm__anx_tscore, mh_p_cbcl__synd__attn_tscore, mh_p_cbcl__synd__aggr_tscore))

```

## 1. Integrity of the Data

The purpose of this section is to complete the following: 

| Step | Purpose |
|------|---------|
| **1 - Specify columns** | Identify the categorical diagnostic outcomes (`bipolar_I`, `bipolar_II`, etc.) and a small set of continuous CBCL scores whose completeness we want to inspect at the 4-year visit |
| **2 - Build helper functions** | Two small functions compute: **`n_non_na`** - how many rows have a usable value (non-missing, non-empty). **`percent_non_na`** - percent of the sample that is non-missing. **`range_or_unique`** - either the min-max range (continuous) or the set of unique values present (categorical) |
| **3 - Apply functions** | `lapply()` runs the helper across every categorical and continuous column, then collapses the results into one tidy data-frame |
| **4 - Display results** | A `kable()` table prints, showing for each variable: how many 4-year cases are usable, what proportion of the cohort that represents, and either the value range (CBCL T-scores) or the actual categories present (0/1 for diagnoses) |

Why we do this:

  - Quickly spot variables with excessive missingness (e.g., 70% complete) before they enter survival or mixed-effects models
  
  - Ensure CBCL scores are within valid T-score bounds (~20-80) and that binary outcomes only contain 0/1

```{r EDA 1, echo = FALSE, warning = FALSE}

## Exploratory Data Analysis ##

#1. Define the N, percent, and range of outcome variables of interest at the 4Y assessment timepoint
#1.1 Define the columns to analyze
#1.11 Categorical columns to analyze
categorical_columns <- c("bipolar_I", "bipolar_II", "any_bsd", "si_passive", "si_active", "sa", "nssi")

#1.12 Continuous columns to analyze
continuous_columns <- c("mh_p_cbcl__dsm__dep_tscore", "mh_p_cbcl__dsm__anx_tscore", "mh_p_cbcl__synd__attn_tscore", "mh_p_cbcl__synd__aggr_tscore")

#1.2 Create a function to compute EDA metrics for both categorical and continuous columns
get_missingness_metrics <- function(data, categorical_columns, continuous_columns) {
  
  #1.21 Helper function for categorical columns
  get_categorical_metrics <- function(column_name) {
    column_data <- data[[column_name]]
    n_non_na <- sum(!is.na(column_data) & column_data != "")
    percent_non_na <- (n_non_na / nrow(data)) * 100
    unique_values <- unique(column_data[!is.na(column_data) & column_data != ""])
    list(
      column = column_name,
      n_non_na = n_non_na,
      percent_non_na = percent_non_na,
      range_or_unique = unique_values
    )
  }
  
  #1.22 Helper function for continuous columns
  get_continuous_metrics <- function(column_name) {
    column_data <- data[[column_name]]
    n_non_na <- sum(!is.na(column_data) & column_data != "")
    percent_non_na <- (n_non_na / nrow(data)) * 100
    value_range <- range(column_data, na.rm = TRUE)
    list(
      column = column_name,
      n_non_na = n_non_na,
      percent_non_na = percent_non_na,
      range_or_unique = value_range
    )
  }
  
  #1.23 Process categorical columns
  categorical_metrics <- lapply(categorical_columns, get_categorical_metrics)
  
  #1.24 Process continuous columns
  continuous_metrics <- lapply(continuous_columns, get_continuous_metrics)
  
  #1.25 Combine results into a single list
  metrics <- c(categorical_metrics, continuous_metrics)
  
  #1.26 Convert to a dataframe for printing in output
  outcome_integrity_metrics <- do.call(rbind, lapply(metrics, function(x) {
    data.frame(
      column = x$column,
      n_non_na = x$n_non_na,
      percent_non_na = x$percent_non_na,
      range_or_unique = I(list(x$range_or_unique))
    )
  }))
  
  return(outcome_integrity_metrics)
}

#1.3 Apply the function to compute EDA metrics for both categorical and continuous columns to the outcome variable data
outcome_variable_integrity <- get_missingness_metrics(prelim_outcome_data_trimmed, categorical_columns, continuous_columns)

# Print the results
kable(outcome_variable_integrity, col.names = c("Variable", "N Non-Missing", "Percent Non-Missing", "Range/Unique Values"), digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"))

```

## 2. Visually and Quantitatively Assess for any Outliers in the Data

The purpose of this section is to: 

| Step | Purpose |
|------|---------|
| **1 - Gather continuous outcomes** | Select the four CBCL T-score variables from the trimmed data and pivot them into long format (`Variable`, `Value`) |
| **2 - Draw faceted box-plots** | `ggplot2` generates a separate box-plot for each T-score, showing the median, IQR, whiskers (1.5×IQR), and any points beyond as potential outliers. Faceting keeps y-scales free so each distribution is shown in its own natural range |
| **3 - Visual inspection** | The resulting panel lets you quickly spot: extreme low/high T-scores (data entry issues?) skew/heavy-tail distributions that might influence clustering or regression |

Why we do this: 

  - Box-plots give an immediate visual flag for values that lie well outside the typical CBCL range (e.g., < 30 or > 100).
  
  - Faceting four plots in one view is an efficient QC step before deciding on transformations or winsorisation.  

```{r EDA 2, echo = FALSE, warning = FALSE}

## Exploratory Data Analysis ##

#2. Visually and Quantitatively Assess for any Outliers in the Data
#2.1 Create boxplots with outlier indicators for continuous variables in the dataset
#2.11 Filter only continuous variables
continuous_outcome_variables <- prelim_outcome_data_trimmed %>%
  dplyr::select(mh_p_cbcl__dsm__dep_tscore, mh_p_cbcl__dsm__anx_tscore, mh_p_cbcl__synd__attn_tscore, mh_p_cbcl__synd__aggr_tscore) %>%
  gather(key = "Variable", value = "Value")

#2.12 Create boxplot with facets for continuous variables
continuous_outcome_variables_boxplot <- ggplot(continuous_outcome_variables, aes(x = Variable, y = Value)) + 
  geom_boxplot(fill = "lightblue", color = "darkblue") + 
  facet_wrap(~ Variable, scales = "free") + 
  theme_minimal() + 
  theme(axis.text.x = element_blank(),
        strip.text = element_text(size = 6, face = "bold")) +
  labs(title = "Boxplots of Continuous Outcome Variables",
       y = "Values",
       x = "")

#2.13 Print the plot
print(continuous_outcome_variables_boxplot)

```

Based on the boxplots of the continuous (secondary) outcome variables, it does not appear as though any values are out of range or otherwise unexpected outliers. However, it does appear as if the data is not normally distributed, and this should be thoroughly assessed in subsequent steps.

## 3. Appropriateness of the Mean as a Measure of Central Tendency

While clustering methods used in this study do not require parametric assumptions, the secondary continuous outcome measures - `cbcl_scr_dsm5_depress_t`, `cbcl_scr_dsm5_anxdisord_t`, `cbcl_scr_syn_attention_t`, and `cbcl_scr_syn_aggressive_t` - will serve as dependent variables in statistical models that do. Therefore, examining kurtosis & skewness provides information about the asymmetry of these variable distributions, which may help identify variables with extreme outliers or long tails (and therefore any adaptations that should be made to our statistical analysis pipeline). 

Below, skewness & kurtosis values for the four secondary outcome measures are presented.

```{r EDA 3, echo = FALSE, warning = FALSE}

## Exploratory Data Analysis ##

#3.1 Calculate skewness & kurtosis for continuous variables
outcome_data_continuous_variables_skewness_kurtosis_table <- prelim_outcome_data_trimmed %>%
  dplyr::select(
    mh_p_cbcl__dsm__dep_tscore,
    mh_p_cbcl__dsm__anx_tscore,
    mh_p_cbcl__synd__attn_tscore,
    mh_p_cbcl__synd__aggr_tscore) %>%
  summarise(
    
  #3.1.1 Calculate skewness & kurtosis for each variable
    across(everything(), list(
      skewness = ~ skewness(.x, na.rm = TRUE),
      kurtosis = ~ kurtosis(.x, na.rm = TRUE)))) %>%
  
  #3.1.2 Reshape from wide to long format
  pivot_longer(
    cols = everything(),
    names_to = c("Variable", "Statistic"),
    names_pattern = "(.*)_(skewness|kurtosis)",
    values_to = "Value") %>%
  
  #3.1.3 Reshape back to have skewness and kurtosis as separate columns
  pivot_wider(names_from = Statistic, values_from = Value)

#3.2 Display the skewness & kurtosis table
kable(outcome_data_continuous_variables_skewness_kurtosis_table, caption = "Skewness & Kurtosis Values for Continuous Variables", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"))

```

**All four outcomes show the typical CBCL pattern; strong positive skew and heavy tails, because most community youth score low while a small clinical subgroup stretches the right tail**

Implications for the longitudinal mixed-effects models: 

| Option | When to choose | Quick note |
|--------|----------------|------------|
| **Keep raw T-scores + robust / bootstrap SEs** | Large sample, focus on mean differences | Central-limit theorem handles skew; report Satterthwaite or bootstrap CIs |
| **Mild transform (√ or log)** | Residual QQ-plots still show heavy tail or heteroscedasticity | Transform, refit LMM, compare AIC/BIC |
| **Non-Gaussian GLMM (e.g., gamma)** | Skew remains problematic after transforms or transforms don't make sense | Fit with `glmmTMB` |

Suggested workflow for analyses: 

  1. Fit the base LMM on raw T-scores with robust SEs
  
  2. Inspect residual QQ-plots and variance-vs-fitted
  
  3. If diagnostics are poor, apply √/log transform and refit; record any change in inference
  
  4. Document choice and likely include GLMM sensitivity in the supplement anyway

## 4. Shape of Each Variables' Distribution

The shape of the distribution for each continuous variable and frequency distribution of each categorical variable is outlined below, both in terms of summary statistics derived from and a graphical histogram with density overlay of relevant data:

```{r EDA 4, echo = FALSE, warning = FALSE, fig.height=10, fig.width=10}

## Exploratory Data Analysis ##

#4. Create summary tables and visualizations for the distributions of categorical and continuous variables included as outcomes by timepoint
#4.1 Create a summary table for continuous and categorical variables by timepoint
summarize_data_by_timepoint <- function(data, continuous_cols, categorical_cols) {
  summary_list <- list()
  
  #4.1.1 Get unique timepoints
  timepoints <- unique(data$session_id)
  timepoints <- timepoints[!is.na(timepoints)]
  
  for (tp in timepoints) {
    tp_data <- data[data$session_id == tp, ]
    
    #4.1.2 Continuous variables summary by timepoint
    for (col in continuous_cols) {
      column_data <- tp_data[[col]]
      valid_values <- column_data[!is.na(column_data)]
      
      if (length(valid_values) > 0) {
        summary_list[[paste0(col, "_", tp)]] <- data.frame(
          Timepoint = tp,
          Variable = col,
          Type = "Continuous",
          N = length(valid_values),
          Mean = mean(valid_values, na.rm = TRUE),
          Median = median(valid_values, na.rm = TRUE),
          SD = sd(valid_values, na.rm = TRUE),
          Min = min(valid_values, na.rm = TRUE),
          Max = max(valid_values, na.rm = TRUE),
          Levels = NA,
          Frequencies = NA,
          stringsAsFactors = FALSE
        )
      }
    }
    
    #4.1.3 Categorical variables summary by timepoint
    for (col in categorical_cols) {
      column_data <- tp_data[[col]]
      freq_table <- table(column_data, useNA = "no")
      
      if (length(freq_table) > 0) {
        summary_list[[paste0(col, "_", tp)]] <- data.frame(
          Timepoint = tp,
          Variable = col,
          Type = "Categorical",
          N = sum(freq_table),
          Mean = NA,
          Median = NA,
          SD = NA,
          Min = NA,
          Max = NA,
          Levels = paste(names(freq_table), collapse = ", "),
          Frequencies = paste(freq_table, collapse = ", "),
          stringsAsFactors = FALSE
        )
      }
    }
  }
  
  do.call(rbind, summary_list)
}

#4.2 Generate the summary table by timepoint
summary_table_by_timepoint <- summarize_data_by_timepoint(prelim_outcome_data_trimmed, continuous_columns, categorical_columns)

#4.3 Print the summary table in the RMD
kable(summary_table_by_timepoint, caption = "Summary Statistics for Outcome Model Variables by Assessment Timepoint", row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed","responsive")) %>%
  column_spec(1, bold = TRUE) %>%
  pack_rows(index = table(summary_table_by_timepoint$Timepoint))

#4.4 Create plots visualizing distributions of variables by timepoint
#4.4.1 Prepare long data for continuous variables
cont_list <- map(continuous_columns, function(col) {
  prelim_outcome_data_trimmed %>%
    select(Value = !!sym(col), session_id) %>%
    filter(!is.na(Value)) %>%
    mutate(Type = "Continuous",
           Variable = col,
           Timepoint = session_id)
})

#4.4.2 Prepare long data for categorical variables
cat_list <- map(categorical_columns, function(col) {
  prelim_outcome_data_trimmed %>%
    select(Value = !!sym(col), session_id) %>%
    filter(!is.na(Value)) %>%
    mutate(Type      = "Categorical",
           Variable  = col,
           Timepoint = session_id)
})

#4.4.3 Combine continuous and categorical data into single frame
plot_data_by_timepoint <- bind_rows(cont_list, cat_list)

#4.4.4 Loop over each assessment timepoint to plot distributions
for (tp in sort(unique(plot_data_by_timepoint$Timepoint))) {

  #4.4.4.1 Filter data for current timepoint
  tp_data <- plot_data_by_timepoint %>%
    filter(Timepoint == tp)

  #4.4.4.2 Generate histogram + density for continuous variables
  cont_plot <- ggplot(tp_data %>% filter(Type == "Continuous"),
                      aes(x = Value)) +
    geom_histogram(aes(y = ..density..),
                   binwidth = 1,
                   fill = "steelblue",
                   alpha = 0.5,
                   color = "black") +
    geom_density(color = "firebrick",
                 size = 0.8,
                 adjust = 1.5) +
    facet_wrap(~ Variable, ncol = 3, scales = "free") +
    theme_minimal(base_size = 9) +
    labs(subtitle = paste("Timepoint:", tp),
         y = "Density",
         x = NULL) +
    theme(strip.text = element_text(size = 7),
          axis.text.x = element_text(angle = 30, hjust = 1, size = 6),
          plot.subtitle = element_text(hjust = 0.5, face = "bold"))

  #4.4.4.3 Generate bar plot for categorical variables
  cat_plot <- ggplot(tp_data %>% filter(Type == "Categorical"),
                     aes(x = factor(Value))) +
    geom_bar(fill = "skyblue",
             color = "black",
             alpha = 0.8) +
    geom_text(stat = "count",
              aes(label = ..count..),
              vjust = -0.3,
              size = 3) +
    facet_wrap(~ Variable, ncol = 3, scales = "free_y") +
    scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
    theme_minimal(base_size = 9) +
    labs(y = "Count", x = NULL) +
    theme(strip.text = element_text(size = 7),
          axis.text.x = element_text(size = 6),
          plot.subtitle = element_text(hjust = 0.5, face = "bold"))

  #4.4.4.4 Stack continuous above categorical and print plots
  print(
    cont_plot / cat_plot +
    plot_annotation(title = "Distributions by Assessment Timepoint") &
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
}

```

Distributions of continuous variables and rates of categorical variables by timepoint are shown above. While continuous variables exhibit noticeable skew & kurtosis, and the CBCL aggression problem scale results will need to be interpreted with caution/re-evaluated during modeling as described in section 3 above, no other problems are noted herein. 

## 5. Distribution of Past-Only vs. Current Diagnoses by Timepoint

In this section, we split each bipolar diagnosis (and the combined “Any BSD” flag) into two mutually exclusive categories:  

  1. Current - youth who meet criteria for a manic/hypomanic or depressive episode at that assessment wave. 
  
  2. Past‐only - youth who endorse a recent past episode (mania/hypomania or “unspecified” bipolar) but do not currently meet criteria for a mood episode  

By tabulating both raw counts and percentages of “current” versus “past‐only” cases at each session, we can see how much of our baseline and follow-up prevalence is driven by active illness versus residual history. This helps contextualize any inflated “Any BSD” rates at early waves and ensures we understand whether “past‐only” cases drop out of the bipolar spectrum once they no longer meet full criteria.

```{r EDA 5, echo = FALSE, warning = FALSE}

## Distribution of Past-Only vs. Current Diagnoses by Timepoint ##

#5.1 Define vectors of raw KSADS columns for current vs. past mania/hypomania (these are subsets of the bd1_vars and bd2_vars already defined)
#5.1.1 Bipolar I “current” flags (any present manic or depressive episode)
bd1_current_vars <- c(
  "mh_p_ksads__bpd__bpd1__curdep__partrem_dx", 
  "mh_p_ksads__bpd__bpd1__curmanic__pres_dx",
  "mh_p_ksads__bpd__bpd1__curdep__pres_dx",
  "mh_y_ksads__bpd__bpd1__curmanic__pres_dx",
  "mh_y_ksads__bpd__bpd1__curdep__pres_dx",
  "mh_p_ksads__bpd__bpd1__curhypo__pres_dx",
  "mh_y_ksads__bpd__bpd1__curhypo__pres_dx",
  "mh_y_ksads__bpd__bpd1__curdep__partrem_dx"
)

#5.1.2 Bipolar I “past‐only” flags
bd1_pastonly_vars <- c(
  "mh_p_ksads__bpd__bpd1__rcnt__manicmix__pres_dx", 
  "mh_y_ksads__bpd__bpd1__rcnt__manic__pres_dx",
  "mh_p_ksads__bpd__bpd1__rcnt__dep__pres_dx",
  "mh_p_ksads__bpd__bpd1__rcnt__manic__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__dep__pres_dx",
  "mh_y_ksads__bpd__bpd1__rcnt__manicmix__pres_dx"
)

#5.1.3 Bipolar II “current” flags (any present hypomanic or depressive episode)
bd2_current_vars <- c(
  "mh_p_ksads__bpd__bpd2__curhypo__pres_dx",
  "mh_p_ksads__bpd__bpd2__curdep__pres_dx",
  "mh_p_ksads__bpd__bpd2__curdep__partrem_dx",
  "mh_y_ksads__bpd__bpd2__curdep__pres_dx",
  "mh_y_ksads__bpd__bpd2__curdep__partrem_dx",
  "mh_y_ksads__bpd__bpd2__curhypo__pres_dx"
)

#5.1.4 Bipolar II “past‐only” flags (recent past hypomania but no current)
bd2_pastonly_vars <- c(
  "mh_p_ksads__bpd__bpd2__rcnt__hypo__pres_dx",
  "mh_y_ksads__bpd__bpd2__rcnt__hypo__pres_dx",
  "mh_p_ksads__bpd__bpd2__rcnt__hypomix__pres_dx",
  "mh_y_ksads__bpd__bpd2__rcnt__hypomix__pres_dx"
)

#5.1.5.1 “Any BSD” current
unspec_current_vars <- c(
  "mh_p_ksads__bpd__unspec__pres_dx",
  "mh_y_ksads__bpd__unspec__pres_dx",
  "mh_p_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_p_ksads__bpd__oth__mindur_dx",
  "mh_y_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_y_ksads__bpd__oth__mindur_dx"
)

#5.1.5.2 “Any BSD” past‐only
unspec_pastonly_vars <- c(
  "mh_p_ksads__bpd__unspec__past_dx",
  "mh_y_ksads__bpd__unspec__past_dx"
)

#5.1.6 Depression qualifiers for baseline & 2-yr rescoring
dep_vars <- c(
  "mh_p_ksads__dep__mdd__partrem_dx",
  "mh_p_ksads__dep__mdd__past_dx",
  "mh_p_ksads__dep__mdd__pres_dx",
  "mh_y_ksads__dep__mdd__partrem_dx",
  "mh_y_ksads__dep__mdd__past_dx",
  "mh_y_ksads__dep__mdd__pres_dx",
  "mh_p_ksads__dep__pdd__oth__pres_dx",
  "mh_p_ksads__dep__pdd__partrem_dx",
  "mh_p_ksads__dep__pdd__past_dx",
  "mh_p_ksads__dep__pdd__pres_dx",
  "mh_y_ksads__dep__pdd__oth__pres_dx",
  "mh_y_ksads__dep__pdd__partrem_dx",
  "mh_y_ksads__dep__pdd__past_dx",
  "mh_y_ksads__dep__pdd__pres_dx"
)

#5.2 Build current vs. past-only flags, with rescoring at ses-00A/02A
prelim_outcome_data2 <- prelim_outcome_data %>%
  mutate(
    
    #5.2.1 BD-I current
    bipolar_I_current = as.numeric(rowSums(dplyr::select(., all_of(bd1_current_vars)) == 1, na.rm=TRUE) > 0),

    #5.2.2 BD-I past-only: require depression at baseline & 2-yr
    bipolar_I_pastonly = case_when(
      rowSums(dplyr::select(., all_of(bd1_pastonly_vars)) == 1, na.rm=TRUE) > 0 &
        (!session_id %in% c("ses-00A","ses-02A") |
          rowSums(dplyr::select(., all_of(dep_vars)) == 1, na.rm=TRUE) > 0) ~ 1,
      TRUE ~ 0),

    #5.2.3 BD-II current
    bipolar_II_current = as.numeric(rowSums(select(., all_of(bd2_current_vars)) == 1, na.rm=TRUE) > 0),

    #5.2.4 BD-II past-only: require depression at baseline & 2-yr
    bipolar_II_pastonly = case_when(
      rowSums(dplyr::select(., all_of(bd2_pastonly_vars)) == 1, na.rm=TRUE) > 0 &
        (!session_id %in% c("ses-00A","ses-02A") |
          rowSums(dplyr::select(., all_of(dep_vars)) == 1, na.rm=TRUE) > 0) ~ 1,
      TRUE ~ 0),

    #5.2.5 Any BSD current
    any_bsd_current = case_when(
      bipolar_I_current == 1 | bipolar_II_current == 1 ~ 1,
      rowSums(dplyr::select(., all_of(unspec_current_vars)) == 1, na.rm = TRUE) > 0 ~ 1,
      TRUE ~ 0),

    #5.2.6 Any BSD past-only (no additional validation)
    any_bsd_pastonly = case_when(
      (bipolar_I_pastonly == 1 | bipolar_II_pastonly == 1) & any_bsd_current == 0 ~ 1,
      rowSums(dplyr::select(., all_of(unspec_pastonly_vars)) == 1, na.rm = TRUE) > 0 &
        any_bsd_current == 0 ~ 1, TRUE ~ 0)) %>%
  
  #5.2.7 Retain only columns of interest to analyses
  dplyr::select(participant_id, session_id,
         bipolar_I_current, bipolar_I_pastonly,
         bipolar_II_current, bipolar_II_pastonly,
         any_bsd_current, any_bsd_pastonly)

#5.3 Summarize counts & percentages by session
diagnosis_summary_by_time <- prelim_outcome_data2 %>%
  pivot_longer(
    cols = c(bipolar_I_current, bipolar_I_pastonly,
             bipolar_II_current, bipolar_II_pastonly,
             any_bsd_current, any_bsd_pastonly),
    names_to = c("Diagnosis","Timing"),
    names_pattern = "(bipolar_I|bipolar_II|any_bsd)_(current|pastonly)",
    values_to = "Flag") %>%
  group_by(session_id, Diagnosis, Timing) %>%
  summarize(
    N_flag = sum(Flag == 1, na.rm=TRUE),
    N_total = n(),
    Pct_flag = 100 * N_flag / N_total,
    .groups = "drop") %>%
  arrange(Diagnosis, Timing, session_id)

#5.4 Print summary table
kable(
  diagnosis_summary_by_time,
  col.names = c("Session","Diagnosis","Timing","N","Total N","Percent"),
  digits = c(0,0,0,0,0,1),
  caption = "Counts & Percentages of Current vs. Past-Only Diagnoses by Session") %>%
  kable_styling(full_width = FALSE)

```

In Section 5, we observe that “Any BSD” and individual bipolar diagnoses generally show their highest prevalence at baseline (ses-00A), with a substantial portion initially classified as “past-only.” Specifically:

- Any BSD
    
  - ses-00A: 2.0% currently met criteria (235 / 11,878) and 7.6% had past-only BSD (904 / 11,878)
    
  - ses-02A: current fell to 1.1% (129 / 11,797), past-only to 3.5% (409 / 11,797)
    
  - ses-04A: current rose to 2.5% (243 / 9,799), past-only held at 0.5% (51 / 9,799)
    
  - ses-06A: current at 3.1% (300 / 9,525), past-only at 0.5% (45 / 9,525)
    
- BD-I
  
  - ses-00A: 0.7% current (81 / 11,878), 0.2% past-only (28 / 11,878)
    
  - ses-02A: 0.4% current (46 / 11,797), 0.2% past-only (24 / 11,797)
    
  - ses-04A: 0.9% current (89 / 9,799), 0.5% past-only (45 / 9,799)
    
  - ses-06A: 1.1% current (102 / 9,525), 0.4% past-only (39 / 9,525)
  
- BD-II

  - ses-00A: 0.3% current (38 / 11,878), 0.1% past-only (17 / 11,878)
  
  - ses-02A: 0.2% current (24 / 11,797), 0.2% past-only (24 / 11,797)
  
  - ses-04A: 0.4% current (37 / 9,799), 0.1% past-only (8 / 9,799)
  
  - ses-06A: 0.4% current (42 / 9,525), 0.1% past-only (7 / 9,525)

After the shift to KSADS-COMP v2.0 (post-ses-02A), “past-only” flags remained very low (< 1%) while “current” rates for Any BSD and BD-I rose modestly—likely reflecting improved measurement combined with developmentally expected increases in the emergence of the disorder.

## 6. Transitions: Who “Drops Out” vs. Who “Converts In” at Adjacent Timepoints

Here we examine longitudinal transitions in each bipolar diagnosis (and Any BSD) between consecutive assessment waves. Specifically, we identify:

  - Dropped Out: Youth who had the diagnosis at time _t_ but no longer meet criteria at time _t+1_
  
  - New On: Youth who did not have the diagnosis at time _t_ but do meet criteria at time _t+1_
  
  - Still Has / Still No: Youth who either continue to have or continue not to have the diagnosis across the two waves

By tabulating raw counts and percentages for each “From → To” pair (e.g., ses-00A → ses-02A), we can quantify how many cases resolve or emerge over time. This helps clarify the stability versus fluctuation of bipolar diagnoses (and combined BSD) across our follow-up waves

```{r EDA 6, echo = FALSE, warning = FALSE}

## Transitions: Who “Drops Out” vs. Who “Converts In” at Adjacent Timepoints ##

#6.1 Pull out only the binary diagnosis columns of interest (keep one “combined” flag per diagnosis)
diag_transitions <- prelim_outcome_data_trimmed %>%
  dplyr::select(participant_id, session_id, bipolar_I, bipolar_II, any_bsd)

#6.2 Pivot to wide format so that for each subject we have:
wide_diags <- diag_transitions %>%
  pivot_wider(
    names_from = session_id,
    values_from = c(bipolar_I, bipolar_II, any_bsd),
    names_sep = "_")

#6.3 Define a helper function to compute “drop‐outs” and “new‐ons” between two session columns
get_transition_counts <- function(df, diag_prefix, time1, time2) {
  col1 <- paste0(diag_prefix, "_", time1)
  col2 <- paste0(diag_prefix, "_", time2)
  
  #6.3.1 Treat NA as 0 (i.e., missing → no diagnosis)
  vect1 <- ifelse(is.na(df[[col1]]), 0, df[[col1]])
  vect2 <- ifelse(is.na(df[[col2]]), 0, df[[col2]])
  
  #6.3.2 Count transitions
  dropped_out <- sum(vect1 == 1 & vect2 == 0)
  still_has <- sum(vect1 == 1 & vect2 == 1)
  new_on <- sum(vect1 == 0 & vect2 == 1)
  still_no <- sum(vect1 == 0 & vect2 == 0)
  
  #6.3.3 Denominators for percentages
  n_with_at_time1 <- dropped_out + still_has
  n_without_at_time1 <- new_on + still_no 
  
  tibble(
    Diagnosis = diag_prefix,
    From = time1,
    To = time2,
    Dropped_Out = dropped_out,
    Still_Has = still_has,
    Pct_Dropped = 100 * dropped_out / max(n_with_at_time1, 1),
    New_On = new_on,
    Still_No = still_no,
    Pct_NewOn = 100 * new_on / (new_on + still_has)
  )
}

#6.4 Specify the ordered sessions you care about (make sure these match the levels in your data)
sessions <- c("ses-00A", "ses-02A", "ses-04A", "ses-06A") 

#6.5 Loop over each diagnosis prefix & each pair of consecutive sessions
all_transitions <- map_dfr(
  c("bipolar_I", "bipolar_II", "any_bsd"),
  function(diag_pref) {
    map_dfr(seq_len(length(sessions) - 1), function(i) {
      get_transition_counts(
        df = wide_diags,
        diag_prefix = diag_pref,
        time1 = sessions[i],
        time2 = sessions[i + 1])})
  }
)

#6.6 Print a transition summary table
kable(
  all_transitions %>%
    dplyr::select(
      Diagnosis, From, To,
      Dropped_Out, Pct_Dropped,
      New_On, Pct_NewOn,
      Still_Has, Still_No),
  col.names = c(
    "Diagnosis", "From", "To",
    "N Dropped", "% dropped (of Time1)",
    "N NewOn", "% new (of Time2)",
    "Still Has", "Still No"),
  digits = c(0, 0, 0, 0, 1, 0, 1, 0, 0),
  caption = "Transition Counts & Percentages Between Consecutive Sessions") %>%
  kable_styling(full_width = FALSE) 

```

Between each pair of available diagnostic waves, nearly all youth who met criteria at the earlier timepoint no longer met criteria at the next (“Dropped” → ~95% for Bipolar I/II, ~86-94% for Any BSD), and most of those diagnosed at the later timepoint were incident cases (“NewOn” → ~78-89% of those with a diagnosis at time *t+1* did not have it at time *t*). More specifically:
  
- BD-I:  
  
  - ses-00A→ses-02A: 100/105 cases (95.2%) dropped, 64/69 cases at ses-02A (92.8%) were new onset, only 5 remained stable

  - ses-02A→ses-04A: 65/69 (94.2%) dropped; 129/133 (97.0%) of ses-04A cases were new 

  - ses-04A→ses-06A: 127/133 (95.5%) dropped; 134/140 (95.7%) of ses-06A cases were new

- BD-II:  
  
  - ses-00A→ses-02A: 31/32 (96.9%) dropped; 28/29 (96.6%) of ses-02A cases were new

  - ses-02A→ses-04A: 29/29 (100%) dropped; 45/45 (100%) of ses-04A cases were new (no one remained)

  - ses-04A→ses-06A: 43/45 (95.6%) dropped; 47/49 (95.9%) of ses-06A cases were new 

- Any BSD:  
  
  - ses-00A→ses-02A: 1,011/1,122 (90.1%) dropped; 415/526 (89.5%) of ses-02A cases were new, and 111 remained stable

  - ses-02A→ses-04A: 495/526 (94.1%) dropped; 263/294 (89.5%) of ses-04A cases were new, and 31 remained stable

  - ses-04A→ses-06A: 255/294 (86.7%) dropped; 306/345 (88.7%) of ses-06A cases were new, and 39 remained stable

In sum, very few youth with Bipolar I/II (or Any BSD) remained positive across waves: most earlier cases “dropped out,” and the vast majority of later cases were new onset. This underscores substantial diagnostic turnover rather than persistence across the available follow-ups. No diagnoses were collected in odd-numbered years, so transitions are shown only for even-year intervals

## 7. Transitions Between Diagnostic Categories

In this section, we create a multi‐state variable that encodes each youth’s bipolar spectrum diagnosis at each wave (No BSD, BD-I, BD-II, Other/Unspecified BSD), then compute the full transition matrix between consecutive waves. This allows us to quantify flows such as BD-I → BD-II, Other BSD → BD-I, etc., both in raw counts and as percentages of the “From” category

```{r EDA 7, echo = FALSE, warning = FALSE}

## Transitions Between Diagnostic Categories ##

#7.1 Assign a single diagnosis state factor for each subject/wave
#7.1.1 Define raw KSADS columns for Other/Unspecified BSD only
other_bsd_vars  <- c(
  "mh_p_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_p_ksads__bpd__oth__mindur_dx",
  "mh_y_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_y_ksads__bpd__oth__mindur_dx",
  "mh_p_ksads__bpd__unspec__pres_dx",
  "mh_p_ksads__bpd__unspec__past_dx",
  "mh_y_ksads__bpd__unspec__pres_dx",
  "mh_y_ksads__bpd__unspec__past_dx"
)

#7.1.2 Create diagnosis flags at each wave (more specific than "any BSD")
state_map <- function(df) {
  df %>%
    mutate(
      diag_state = case_when(
        
        #7.1.2.1 BD-I if any BD1 flag (current or past-only)
        bipolar_I_current == 1 | bipolar_I_pastonly == 1 ~ "BD1",
        
        #7.1.2.2 BD-II if any BD2 flag
        bipolar_II_current == 1 | bipolar_II_pastonly == 1 ~ "BD2",
        
        #7.1.2.3 OtherBSD only if an unspec flag and NO BD1/BD2
        rowSums(dplyr::select(., all_of(other_bsd_vars))  == 1, na.rm=TRUE) > 0 ~ "OtherBSD",
        
        #7.1.2.4 Otherwise no spectrum diagnosis
        TRUE ~ "NoBSD") %>%
      factor(levels = c("NoBSD","BD1","BD2","OtherBSD"))
    )
}

#7.1.3 Apply mapping to produce `prelim_states`
prelim_states <- prelim_outcome_data2 %>%
  left_join(prelim_outcome_data) %>% 
  filter(session_id == "ses-00A" | session_id == "ses-02A" | session_id == "ses-04A" | session_id == "ses-06A" | session_id == "ses-08A") %>% 
  state_map()

#7.2 Pivot data to one row per subject with diag_state_<session> columns
wide_states <- prelim_states %>%
  dplyr::select(participant_id, session_id, diag_state) %>%
  pivot_wider(
    names_from = session_id,
    values_from = diag_state,
    names_prefix = "diag_state_"
  )

#7.3 Create a function to compute transition counts and % for a given pair of sessions
get_state_matrix <- function(df, from_sess, to_sess) {
  tbl <- table(
    From = df[[paste0("diag_state_", from_sess)]],
    To = df[[paste0("diag_state_", to_sess)]])
  prop_tbl <- prop.table(tbl, margin = 1) * 100
  list(counts = tbl, props = prop_tbl)
}

#7.4 Create Transition Matrices for Each Pair of Waves
#7.4.1 Define your waves of interest
sessions <- c("ses-00A", "ses-02A", "ses-04A", "ses-06A", "ses-08A")

#7.4.2 Build a combined summary
transitions_summary <- map_dfr(seq_len(length(sessions) - 1), function(i) {
  from <- sessions[i]; to <- sessions[i + 1]
  mat <- get_state_matrix(wide_states, from, to)
  cnts <- as.matrix(mat$counts)
  prps <- round(as.matrix(mat$props), 1)
  tibble(
    Transition = paste0(from, "→", to),
    From = rownames(cnts),
    NoBSD = paste0(cnts[,"NoBSD"], " (", prps[,"NoBSD"], "%)"),
    BD1 = paste0(cnts[,"BD1"], " (", prps[,"BD1"], "%)"),
    BD2 = paste0(cnts[,"BD2"], " (", prps[,"BD2"], "%)"),
    OtherBSD = paste0(cnts[,"OtherBSD"], " (", prps[,"OtherBSD"], "%)")
  )
})

#7.4.3 Render the table and group by timepoint
transitions_summary %>%
  dplyr::select(-Transition) %>%
  kable(
    col.names = c("From","NoBSD","BD1","BD2","OtherBSD"),
    align = "c",
    caption = "Transition Counts & Percentages Between Diagnostic States") %>%
  kable_styling(full_width = FALSE) %>%
  pack_rows(index = table(transitions_summary$Transition))

#7.5 Create a Sankey diagram displaying transitions between diagnostic categories across timepoints
#7.5.1 Store transition counts from each sequential timepoint to the next
links <- map_dfr(seq_len(length(sessions)-1), function(i) {
  from <- sessions[i]; to <- sessions[i+1]
  mat <- get_state_matrix(wide_states, from, to)$counts
  
  #7.5.1.1 Use expand.grid to create transition count dataframe
  df <- expand.grid(
    From = rownames(mat), 
    To = colnames(mat),
    stringsAsFactors = FALSE) %>%
    mutate(
      value = as.vector(mat),
      source = paste0(from, "_", From),
      target = paste0(to, "_", To)) %>%
    filter(value > 0) 
  return(df)
})

#7.5.2 Build nodes for Sankey
nodes <- data.frame(
  name = unique(c(links$source, links$target)),
  stringsAsFactors = FALSE
)

#7.5.3 Map source/target to node IDs
links <- links %>%
  mutate(
    IDsource = match(source, nodes$name) - 1,
    IDtarget = match(target, nodes$name) - 1
  )

#7.5.4 Plot Sankey diagram
cat("Sankey Diagram of Transition Counts Between Diagnostic States\n")
sankeyNetwork(
  Links = links,
  Nodes = nodes,
  Source = "IDsource",
  Target = "IDtarget",
  Value = "value",
  NodeID = "name",
  fontSize = 8,
  nodeWidth = 30,
  sinksRight = FALSE
)

```

Across each consecutive assessment wave, most youth without a bipolar diagnosis remained stable (~97% NoBSD→NoBSD), though small numbers transitioned into BD-I, BD-II, or Other/Unspecified BSD categories (0.2-3.2%). 

Youth initially diagnosed with BD-I, BD-II, or Other BSD demonstrated high diagnostic instability. For example, between baseline and the 2-year follow-up, 87.5% of BD-I youth transitioned to NoBSD, with similarly high rates for BD-II (85.4%) and OtherBSD (90%). This pattern persisted across subsequent follow-ups, reflecting substantial flux rather than diagnostic persistence, particularly notable in transitions from diagnostic categories back to No BSD.

Another informative spot check is how many youth have any BSD at multiple timepoints. In brief, 1,793 (15.1%) participants have any BSD at any 1 of the timepoints; 229 (1.9%) participants have any BSD at 2 timepoints; 19 (0.16%) participants have any BSD at 3 timepoints; and 2 (0.01%) participants have any BSD at all 4 timepoints. 

## 8. Tiered Bipolar‐Spectrum Definitions & Their Stability

As forms of potential sensitivity analyses and to increase the specificity and sensitivity in our BSD cases, we define four “tiers” of increasing diagnostic stringency at each assessment timepoint to compare to just KSADS-COMP derived diagnoses:

  1. **Tier 1**: All four CBCL subscales (depression, anxiety, attention, aggression) >= 65 T-score  
  
  2. **Tier 2**: Tier 1 **+** GBI Mania total >= 12 

  3. **Tier 3**: KSADS any BSD (current or past-only) **+** Tier 1  

  4. **Tier 4**: KSADS any BSD **+** Tier 1 **+** GBI Mania >= 12  
  
We then count, for each youth, at how many of the four timepoints of interest (baseline, 2-year, 4-year, and 6-year follow-ups) they meet each tier, and display the distribution of those counts.

```{r EDA 8, echo = FALSE, warning = FALSE}

## Tiered Bipolar‐Spectrum Definitions & Their Stability ##

#8.1 Create tiered diagnosis flags
#8.11 Merge CBCL & GBI scores onto our diagnosis flags
tier_data <- prelim_outcome_data2 %>%
  left_join(
    prelim_outcome_data %>%
      dplyr::select(
        participant_id, session_id,
        mh_p_cbcl__dsm__dep_tscore,
        mh_p_cbcl__dsm__anx_tscore,
        mh_p_cbcl__synd__attn_tscore,
        mh_p_cbcl__synd__aggr_tscore,
        mh_p_gbi_sum),
    by = c("participant_id", "session_id")
  )

#8.12 Define tier flags (1/0) per subject row (i.e., at each timepoint)
tier_data <- tier_data %>%
  mutate(
    any_bsd_flag  = as.numeric(any_bsd_current==1 | any_bsd_pastonly==1),
    tier1 = as.numeric(
      mh_p_cbcl__dsm__dep_tscore >= 65 &
      mh_p_cbcl__dsm__anx_tscore >= 65 &
      mh_p_cbcl__synd__attn_tscore >= 65 &
      mh_p_cbcl__synd__aggr_tscore >= 65),
    tier2 = as.numeric(tier1 == 1 & mh_p_gbi_sum >= 12),
    tier3 = as.numeric(any_bsd_flag == 1 & tier1 == 1),
    tier4 = as.numeric(any_bsd_flag == 1 & tier1 == 1 & mh_p_gbi_sum >= 12)
  )

#8.2 Determine the prevalence of Each Tier by Timepoint
#8.2.1 Build a long table of tier flags
tier_long <- tier_data %>%
  dplyr::select(participant_id, session_id, tier1:tier4) %>%
  pivot_longer(
    cols = tier1:tier4,
    names_to = "Tier",
    values_to = "Flag"
  )

#8.2.2 Summarize N and percent per Tier × Timepoint
tier_prev <- tier_long %>%
  group_by(session_id, Tier) %>%
  summarise(
    N_flag = sum(Flag == 1, na.rm=TRUE),
    N_total = n_distinct(participant_id),
    Percent = 100 * N_flag / N_total,
    .groups = "drop") %>%
  arrange(Tier, session_id)

#8.2.3 Print occurrence rate table 
kable(
  tier_prev,
  col.names = c("Session", "Tier", "N Endorsed", "Total N", "% Endorsed"),
  digits = c(0, 0, 0, 0, 2),
  caption = "Prevalence of Each Tier by Wave") %>%
  kable_styling(full_width = FALSE) %>%
  pack_rows("Tier1 (CBCL BD Profile >= 65)", 1, length(unique(tier_prev$session_id))) %>%
  pack_rows("Tier2 (+GBI Mania >= 12)", length(unique(tier_prev$session_id)) +
              1, 2 * length(unique(tier_prev$session_id))) %>%
  pack_rows("Tier3 (+KSADS Any BSD)",
            2 * length(unique(tier_prev$session_id)) + 1,
            3 * length(unique(tier_prev$session_id))) %>%
  pack_rows("Tier4 (All criteria)", 3 * length(unique(tier_prev$session_id)) +
              1, 4 * length(unique(tier_prev$session_id)))

#8.3 Determine the stability of each tier across timepoints
#8.3.1 Pivot wide: one column per tier × session
wide_tiers <- tier_long %>%
  pivot_wider(
    names_from  = c(Tier, session_id),
    values_from = Flag,
    names_sep   = "_"
  )

#8.3.2 Write a helper function for diagnostic transitions across time
get_transition_counts <- function(df, prefix, t1, t2) {
  c1 <- paste0(prefix, "_", t1)
  c2 <- paste0(prefix, "_", t2)
  v1 <- ifelse(is.na(df[[c1]]), 0, df[[c1]])
  v2 <- ifelse(is.na(df[[c2]]), 0, df[[c2]])
  dropped <- sum(v1==1 & v2==0)
  still <- sum(v1==1 & v2==1)
  newon <- sum(v1==0 & v2==1)
  still_no <- sum(v1==0 & v2==0)
  tibble(
    Tier = prefix,
    From = t1,
    To = t2,
    Dropped = dropped,
    Still = still,
    Pct_Drop  = 100 * dropped / max(dropped+still,1),
    NewOn = newon,
    StillNo = still_no,
    Pct_Newon = 100 * newon / max(newon+still,1)
  )
}

#8.3.3 Loop over tiers & session pairs counting diangostic transitions
sessions <- c("ses-00A","ses-02A","ses-04A","ses-06A")
all_tier_trans <- map_dfr(
  c("tier1","tier2","tier3","tier4"),
  ~ map_dfr(seq_len(length(sessions)-1), function(i) {
    get_transition_counts(wide_tiers, .x, sessions[i], sessions[i+1])})
)

#8.3.4 Print summary of diagnostic transitions across timepoints
kable(
  all_tier_trans,
  col.names = c("Tier","From","To",
                "N Dropped","N Still Has","% dropped",
                "N NewOnset","N Still No","% NewOnset"),
  digits = c(0,0,0,0,0,1,0,0,1),
  caption = "Tier Transition Counts & Percentages Between Waves") %>%
  kable_styling(full_width = FALSE)

#8.4 Build Sankey diagrams for each tier
#8.4.1 Create tier labels for plots
tier_labels <- c(
  tier1 = "Tier 1 - CBCL >=65 on All 4 Subscales",
  tier2 = "Tier 2 - Tier 1 + GBI Mania >=12",
  tier3 = "Tier 3 - Any BSD + Tier 1",
  tier4 = "Tier 4 - Any BSD + Tier 1 + GBI Mania >=12"
)

#8.4.2 Loop through each tier and create a sankey diagram for diagnostic transitions over time
widgets <- map(names(tier_labels), function(prefix) {
  
  #8.4.2.1 Build links
  links <- map_dfr(seq_len(length(sessions)-1), function(i) {
    t1 <- sessions[i]; t2 <- sessions[i+1]
    mat <- table(
      From = wide_tiers[[paste0(prefix, "_", t1)]],
      To = wide_tiers[[paste0(prefix, "_", t2)]]
    )
    expand.grid(From = rownames(mat), To = colnames(mat), 
                stringsAsFactors = FALSE) %>%
      mutate(
        value = as.vector(mat),
        source = paste0(t1, "_", From),
        target = paste0(t2, "_", To)) %>% 
      filter(value > 0)
  })
  
  #8.4.2.2 Build nodes
  nodes <- data.frame(name = unique(c(links$source, links$target)),
                      stringsAsFactors = FALSE)
  
  #8.4.2.3 Map links onto nodes
  links <- links %>%
    mutate(
      IDsource = match(source, nodes$name) - 1,
      IDtarget = match(target, nodes$name) - 1)
  
  #8.4.2.4 Build each sankey diagram
  sankey <- sankeyNetwork(
    Links = links,
    Nodes = nodes,
    Source = "IDsource",
    Target = "IDtarget",
    Value = "value",
    NodeID = "name",
    fontSize = 10,
    nodeWidth = 20,
    sinksRight= FALSE
  )
  
  #8.4.2.5 Return each sankey diagram
  tagList(
    tags$h4(tier_labels[prefix]),
    sankey
  )
})

#8.4.3 Render all sankey diagrams in the output
browsable(tagList(widgets))

```

Across the four even-year follow-up timepoints, the tiers are quite low in occurrence rate; and unsurprisingly, the stricter the definition, the rarer each tier is in ABCD.

Moreover, all four tiers show marked instability (ses-00 → 02 → 04 → 06):

  - Tier 1: ~79% of baseline cases drop by 2 yrs; new-onset cases each wave are 69-83% of those diagnosed at the next wave, leaving 10-30 participants (13.2-21.0%) who persist from one wave to the next.

  - Tier 2: >= 88% of baseline cases remit by 2 yrs and >= 81% of the next-wave cases are incident.

  - Tier 3: 88% of baseline Tier 3 participants lose the tier by 2 yrs; every following Tier 3 case except for 1 is incident (100% “new-onset”) and none persist across consecutive waves.

  - Tier 4: The strictest definition is almost entirely transient; every wave after baseline sees almost complete drop-out of prior Tier 4 cases and 100% of the few subsequent Tier 4 diagnoses are new relative to previous timepoints.

**Overall**, < 1.5% of the ABCD cohort ever meets Tier 1, < 0.5% meets Tier 2, and Tier 3/Tier 4 occur in only a few dozen participants each wave. Persistence across multiple waves is exceptionally rare (single digit numbers of participants meet Tier 3 or Tier 4 at two consecutive waves). To me, these findings reinforce that even with additional “validation” criteria, bipolar-spectrum indicators in ABCD are infrequent and highly unstable over time. Which is not to say that we shouldn't trust that our clinical classifications aren't useful or even that they don't represent bipolar in a way we wouldn't expect; just that they are limited by how much we trust their validity & reliability compared to clinician administered diagnoses

##9. Clarifying Bipolar NOS Diagnoses

Given that the unspecified bipolar and related disorder diagnoses occur in much higher rates than anticipated at the baseline and 2-year follow-up assessment timepoints (when KSADS 1.0 was delivered) and are highly unstable across time, we will do the following to determine whether we can operationalize the unspecified bipolar and related disorder diagnoses from those two timepoints in a manner that allows us to trust the data (i.e., whether subjects with said diagnoses are truly experiencing BD symptomatology): 

  1. Check whether any assessment sites have inflated rates of these diagnoses
  
  2. Stratify the BD NOS cases by GBI scores > 12 and check what patterns emerge over time (e.g., stability)
  
As such, we will first examine the rates of BD NOS diagnoses (and BD NOS diagnoses stratified by GBI mania >= 12) at each assessment site:

```{r eda 9.1, warning = FALSE, echo = FALSE, fig.height = 11.5, fig.width = 8.5}

## Clarifying Bipolar NOS Diagnoses ##

#9.1 Check whether any assessment sites have inflated rates of these diagnoses
#9.1.1 Define the exact OtherBSD columns and sessions of interest
other_bsd_vars <- c(
  "mh_p_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_p_ksads__bpd__oth__mindur_dx",
  "mh_y_ksads__bpd__bpd2__oth__mindur_dx",
  "mh_y_ksads__bpd__oth__mindur_dx",
  "mh_p_ksads__bpd__unspec__pres_dx",
  "mh_p_ksads__bpd__unspec__past_dx",
  "mh_y_ksads__bpd__unspec__pres_dx",
  "mh_y_ksads__bpd__unspec__past_dx"
)
sessions <- c("ses-00A", "ses-02A")

#9.1.2 Build working dataframe of outcomes of interest & assessment site data
#9.1.2.1 Create a dataframe containing complete site information
site_data <- raw_data %>%
  dplyr::select(c(participant_id, session_id, ab_g_dyn__design_site)) %>% 
group_by(participant_id) %>%
  
  #9.1.2.1.1 For each participant, fill NA values with the first non-NA value found
  fill(ab_g_dyn__design_site, .direction = "updown") %>%
  ungroup()

#9.1.2.2 Join the site data with the outcome data & flag BD NOS & GBI >= 12 cases
bdnos_site <- prelim_outcome_data %>%
  filter(session_id %in% sessions) %>%
  left_join(site_data, by=c("participant_id","session_id")) %>%
  dplyr::select(participant_id, session_id, all_of(other_bsd_vars), bipolar_I, bipolar_II, mh_p_gbi_sum, ab_g_dyn__design_site) %>%
  
  #9.1.2.2.1 Flag NOS vs. GBI‐high subjects
  mutate(
    unspec_flag = +(
      
      #9.1.2.2.1.1 has any of the OtherBSD flags
      rowSums(select(., all_of(other_bsd_vars)) == 1, na.rm=TRUE) > 0
      
      #9.1.2.2.1.2 but not BD-I or BD-II
      & bipolar_I == 0 & bipolar_II == 0),
    gbi_high = +(mh_p_gbi_sum >= 12)) %>%
  filter(!is.na(ab_g_dyn__design_site))

#9.1.3 Summarize data by site & session
site_summary <- bdnos_site %>%
  group_by(ab_g_dyn__design_site, session_id) %>%
  filter(session_id == "ses-00A" | session_id == "ses-02A") %>% 
  summarise(
    total = n(),
    nos_cases = sum(unspec_flag),
    nos_gbi = sum(unspec_flag & gbi_high),
    .groups = "drop") %>%
  
  #9.1.3.1 ensure every site×session appears
  complete(
    ab_g_dyn__design_site,
    session_id = sessions,
    fill = list(total=0, nos_cases=0, nos_gbi=0)) %>%
  
  #9.1.3.2 compute percentages, converting any NaN/NA → 0
  mutate(
    pct_nos = if_else(total>0, 100 * nos_cases/total, 0),
    pct_nos_gbi = if_else(nos_cases>0, 100 * nos_gbi/nos_cases, 0)) %>%
  arrange(ab_g_dyn__design_site, session_id) %>% 
  dplyr::select(c(ab_g_dyn__design_site, session_id, total, nos_cases, pct_nos, nos_gbi, pct_nos_gbi))

#9.1.4 Print cleaned summary table
kable(site_summary, 
      col.names = c("Site","Session","Total Site N","N BD NOS","% BD NOS","N BD NOS + GBI>=12","% of NOS w GBI>=12"), 
      digits = c(0,0,0,0,2,0,2),
      caption = "Site-Level Unspecified BSD Rates by Session") %>%
  kable_styling(full_width = FALSE)


#9.1.5 Plot BD NOS data (and cases stratified by GBI>=12)                                                
plot_df <- site_summary %>%  
  
  #9.1.5.1 Compute overall % BD NOS & GBI>=12                        
  mutate(
    pct_nos_and_gbi_total = if_else(total > 0, 100 * nos_gbi / total, 0)) %>%
  
  #9.1.5.2 Pivot to long format
  pivot_longer(
    cols = c(pct_nos, pct_nos_and_gbi_total),
    names_to = "metric",
    values_to = "percent") %>%
  
  #9.1.5.3 Recode metric names and reorder sites within each session by % BD NOS
  mutate(
    metric = recode(metric,
      pct_nos = "% BD NOS (of total)",
      pct_nos_and_gbi_total = "% BD NOS + GBI>=12 (of total)"),
    site_reordered = reorder_within(
      ab_g_dyn__design_site,
      percent,
      session_id,
      .fun = max)
  )

#9.1.5.4 Plot bar‐chart of % BD NOS vs. % BD NOS + GBI>=12 by site & session
ggplot(plot_df, aes(
  x = site_reordered,
  y = percent,
  fill = metric)) +
  
  #9.1.5.4.1 Draw grouped bars
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  
  #9.1.5.4.2 Separate panels for each session, free y-scale 
  facet_wrap(~ session_id, ncol = 1, scales = "free_y") +
  
  #9.1.5.4.3 Restore original site labels
  scale_x_reordered() +
  coord_flip() +
  
  #9.1.5.4.4 Custom two-tone fill palette
  scale_fill_manual(
    values = c("#9E2A2B", "#4C72B0")) +
  
  #9.1.5.4.5 Labels and title
  labs(
    x = "Assessment Site (ordered by % BD NOS)",
    y = "Percent of Site Sample",
    fill = NULL,
    title = "Unspecified BSD & GBI>=12 (of Total) by Site & Session") +
  
  #9.1.5.4.6 Clean theme & spacing tweaks
  theme_minimal(base_size = 11) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.y = element_text(size = 7),
    panel.spacing = unit(0.75, "lines"),
    legend.position = "top"
  )

```

From these results, it is evident that some sites (e.g., 22 AKA Mount Sinai and 15 AKA Pitt) have a much higher incidence rate of BD NOS cases diagnosed per-capita (e.g., 16% and 13% at baseline, respectively).

However, even the lowest incidence rates for BD NOS cases at any site (i.e., 3.6% at site 16 AKA University of Utah, followed by 5.9% at site 10 AKA UCSD) exceeds the rate we would expect to observe in the population. So, while some scrutiny could be placed on diagnoses coming from specific sites (i.e., us stratifying our study participants in that way), it is likely that a more broad stratification criteria based on symptoms applied to the whole data set would be more appropriate for "trusting" the diagnoses here.

In this same vein, we will now examine the incidence and stability of BD NOS cases across the baseline and 2-year follow-up set when stratified by GBI mania scores >= 12. 

Additionally, on this same topic, correspondence with Dr. Kenneth Kobak on 06/25/2025 related to the algorithms used to indicate BD NOS diagnoses in KSADS 1.0 vs 2.0 revealed that the only difference between the BD NOS diagnoses derived from KSADS 1.0 and 2.0 is the necessary presence of 1) a past or current MDD diagnosis and 2) 3 hypomania symptoms (as opposed to 2 symptoms) using KSADS 2.0. 

As such, below is also another sort of spot check comparing the rates of BD NOS diagnosis across time when we stratify the cases at baseline and 2-year follow-up (i.e., derived from KSADS 1.0) by those with a part or current MDD diagnosis:

```{r eda 9.2, warning = FALSE, echo = FALSE, fig.height = 11.5, fig.width = 8.5}

## Clarifying BD NOS Diagnoses: GBI Mania & Lifetime MDD Spot Checks ##

#9.2.1 Augment bdnos_site with lifetime‐MDD (only MDD columns) and pivot for 00A & 02A 
#9.2.1.1 Define the six KSADS‐COMP MDD columns to use
mdd_only_vars <- c(
  "mh_p_ksads__dep__mdd__pres_dx",
  "mh_p_ksads__dep__mdd__past_dx",
  "mh_p_ksads__dep__mdd__partrem_dx",
  "mh_y_ksads__dep__mdd__pres_dx",
  "mh_y_ksads__dep__mdd__past_dx",
  "mh_y_ksads__dep__mdd__partrem_dx"
)

#9.2.1.2 Join MDD flags onto bdnos_site, compute gbi & mdd flags, filter to 00A/02A, and pivot wide
bdnos_site2 <- bdnos_site %>%
  
  #9.2.1.2.1 Bring in only the six MDD columns from raw_data_trimmed
  left_join(
  raw_data_trimmed %>% 
  dplyr::select(participant_id, session_id, all_of(mdd_only_vars)),
  by = c("participant_id", "session_id")) %>%
  
  #9.2.1.2.2 Compute binary MDD flag (any of the six = 1)
  mutate(
  mdd_flag = +(
  rowSums(dplyr::select(., all_of(mdd_only_vars)) == 1, na.rm = TRUE) > 0)) %>%
  
  #9.2.1.2.3 Keep only the flags and identifiers
  dplyr::select(participant_id, session_id, unspec_flag, gbi_high, mdd_flag) %>%
  
  #9.2.1.2.4 Filter down to the two KSADS 1.0 waves
  filter(session_id %in% c("ses-00A", "ses-02A")) %>%
  
  #9.2.1.2.5 Pivot to wide so each subject has columns for each flag at each wave
  pivot_wider(
  names_from  = session_id,
  values_from = c(unspec_flag, gbi_high, mdd_flag),
  names_sep = "__") %>%
  
  #9.2.1.2.6 Rename for readability
  rename_with(~ str_replace_all(.x, 
    c(
    "unspec_flag__ses-00A" = "unspec_00A",
    "unspec_flag__ses-02A" = "unspec_02A",
    "gbi_high__ses-00A" = "gbi_00A",
    "gbi_high__ses-02A" = "gbi_02A",
    "mdd_flag__ses-00A" = "mdd_00A",
    "mdd_flag__ses-02A" = "mdd_02A")), everything())

#9.2.2 Prevalence tables at 00A & 02A 
#9.2.2.1 Build a summary tibble with counts and percentages for NOS alone, NOS+GBI, NOS+MDD
prev_table <- tibble(Session = c("ses-00A", "ses-02A")) %>%
  mutate(
    
    #9.2.2.1.1 total N (same for both rows)
    N = nrow(bdnos_site2),
    
    #9.2.2.1.2 counts of BD NOS at each wave
    BD_NOS = c(
      sum(bdnos_site2$unspec_00A == 1, na.rm = TRUE),
      sum(bdnos_site2$unspec_02A == 1, na.rm = TRUE)),
    
    #9.2.2.1.3 % BD NOS of total
    `% NOS` = 100 * BD_NOS / N,
    
    #9.2.2.1.4 counts of BD NOS & high GBI
    BD_NOS_GBI = c(
      sum(bdnos_site2$unspec_00A & bdnos_site2$gbi_00A, na.rm = TRUE),
      sum(bdnos_site2$unspec_02A & bdnos_site2$gbi_02A, na.rm = TRUE)),
    
    #9.2.2.1.5 % BD NOS & GBI>=12 of total
    `% NOS+GBI>=12` = 100 * BD_NOS_GBI / N,
    
    # 9.2.2.1.6 counts of BD NOS & lifetime MDD
    BD_NOS_MDD = c(
      sum(bdnos_site2$unspec_00A & bdnos_site2$mdd_00A, na.rm = TRUE),
      sum(bdnos_site2$unspec_02A & bdnos_site2$mdd_02A, na.rm = TRUE)),
    
    #9.2.2.1.7 % BD NOS & MDD of total
    `% NOS+MDD` = 100 * BD_NOS_MDD / N,
    
    #9.2.2.1.8 counts of BD NOS & (GBI>=12 & lifetime MDD)
    BD_NOS_GBI_MDD = c(
      sum(bdnos_site2$unspec_00A & bdnos_site2$gbi_00A & bdnos_site2$mdd_00A, na.rm = TRUE),
      sum(bdnos_site2$unspec_02A & bdnos_site2$gbi_02A & bdnos_site2$mdd_02A, na.rm = TRUE)),
    
    #9.2.2.1.9 % BD NOS & GBI>=12 & MDD of total
    `% NOS+GBI+MDD` = 100 * BD_NOS_GBI_MDD / N
  )

#9.2.2.2 Print the combined prevalence table
kable(
  prev_table,
  caption = "Overall Prevalence of BD NOS and Its Co-occurrence with GBI>=12 and Lifetime MDD",
  col.names = c(
    "Session", "Total N",
    "N NOS", "% NOS",
    "N NOS+GBI>=12","% NOS+GBI>=12",
    "N NOS+MDD", "% NOS+MDD",
    "N NOS+GBI+MDD","% NOS+GBI+MDD"),
  digits = c(0,0,0,1,0,1,0,1,0,1)) %>%
  kable_styling(full_width = FALSE)

#9.2.3 Transition tables by GBI & by MDD 
#9.2.3.1 Helper to compute drop/new stats for any binary flag
make_transitions <- function(df, flag00, flag02) {
  df %>% summarize(
  N_w_00A = sum({{flag00}} == 1, na.rm=TRUE),
  N_wo_00A  = sum({{flag00}} == 0, na.rm=TRUE),
  Dropped = sum({{flag00}} == 1 & {{flag02}} == 0, na.rm=TRUE),
  Still_Has = sum({{flag00}} == 1 & {{flag02}} == 1, na.rm=TRUE),
  New_Onset = sum({{flag00}} == 0 & {{flag02}} == 1, na.rm=TRUE),
  `%Dropped`  = 100 * Dropped / max(N_w_00A,1),
  `%NewOnset` = 100 * New_Onset / max(N_wo_00A,1))
}

#9.2.3.2 Transitions stratified by GBI Mania >= 12 at baseline
trans_gbi <- bdnos_site2 %>%
  group_by(GBI_Stratum = if_else(gbi_00A == 1, "GBI >=12", "GBI <12")) %>%
  make_transitions(unspec_00A, unspec_02A)

#9.2.3.3 Transitions stratified by Lifetime MDD at baseline
trans_mdd <- bdnos_site2 %>%
  group_by(MDD_Stratum = if_else(mdd_00A == 1, "MDD+", "MDD-")) %>%
  make_transitions(unspec_00A, unspec_02A)

#9.2.3.4 Print transition tables
#9.2.3.4.1 BD NOS + GBI
kable(
  trans_gbi,
  caption = "BD NOS Transitions 00A→02A by Baseline GBI Mania Stratum",
  col.names = c("GBI Stratum","N @00A","N no @00A",
      "Dropped","Still Has","New","%Dropped","%NewOnset"),
  digits = c(0,0,0,0,0,0,1,1)) %>% 
  kable_styling(full_width = FALSE)

#9.2.3.4.1 BD NOS + MDD
kable(
  trans_mdd,
  caption = "BD NOS Transitions 00A→02A by Baseline Lifetime MDD Stratum",
  col.names = c("MDD Stratum","N @00A","N no @00A",
      "Dropped","Still Has","New","%Dropped","%NewOnset"),
  digits = c(0,0,0,0,0,0,1,1)) %>% 
  kable_styling(full_width = FALSE)

#9.2.4 Create sankey diagrams outlining the transition flow for each subgroup
#9.2.4.1 Sankey: BD NOS → BD NOS by GBI Mania Stratum 
for (strat in na.omit(unique(bdnos_site2$gbi_00A))) {
  
  #9.2.4.1.1 Subset to this GBI stratum
  df_str <- bdnos_site2 %>% 
    filter(gbi_00A == strat)
  
  #9.2.4.1.2 Build transition matrix (No NOS → NOS)
  mat <- table(
    From = factor(ifelse(df_str$unspec_00A == 1, "NOS", "No NOS"),
                  levels = c("No NOS","NOS")),
    To = factor(ifelse(df_str$unspec_02A == 1, "NOS", "No NOS"),
                  levels = c("No NOS","NOS")))
  
  #9.2.4.1.3 Convert to long format and drop zero flows
  links <- as.data.frame(mat) %>% 
    filter(Freq > 0) %>% 
    transmute(
      source = paste0("00A_", From),
      target = paste0("02A_", To),
      value  = Freq)
  
  #9.2.4.1.4 Create node list
  nodes <- data.frame(
    name = unique(c(links$source, links$target)),
    stringsAsFactors = FALSE)
  
  #9.2.4.1.5 Map to zero-based node IDs
  links <- links %>%
    mutate(
      IDsource = match(source, nodes$name) - 1,
      IDtarget = match(target, nodes$name) - 1)
  
  #9.2.4.1.6 Friendly label for this stratum
  strat_label <- ifelse(strat == 1, "GBI >=12", "GBI <12")
  cat("#### Sankey: BD NOS 00A→02A (", strat_label, ")\n\n", sep = "")
  
  #9.2.4.1.7 Render the Sankey
  print(networkD3::sankeyNetwork(
    Links = links,
    Nodes = nodes,
    Source = "IDsource",
    Target = "IDtarget",
    Value = "value",
    NodeID = "name",
    fontSize = 10,
    nodeWidth = 30,
    sinksRight = FALSE))
  
  cat("\n\n")
}

#9.2.4.2 Sankey: Lifetime MDD
#9.2.4.2.1 Loop only over non‐NA MDD strata
for (strat in na.omit(unique(bdnos_site2$mdd_00A))) {

  #9.2.4.2.2 Subset to this MDD stratum
  df_m <- bdnos_site2 %>%
    filter(mdd_00A == strat)

  #9.2.4.2.3 Build transition matrix (No NOS → NOS)
  mat_m <- table(
    From = factor(ifelse(df_m$unspec_00A == 1, "NOS", "No NOS"),
                  levels = c("No NOS","NOS")),
    To = factor(ifelse(df_m$unspec_02A == 1, "NOS", "No NOS"),
                  levels = c("No NOS","NOS")))

  #9.2.4.2.4 Convert to data.frame and drop zero flows
  links_m <- as.data.frame(mat_m) %>%
    filter(Freq > 0) %>%
    transmute(
      source = paste0("00A_", From),
      target = paste0("02A_", To),
      value = Freq)

  #9.2.4.2.5 Build node list
  nodes_m <- data.frame(
    name = unique(c(links_m$source, links_m$target)),
    stringsAsFactors = FALSE)

  #9.2.4.2.6 Map to zero-based node IDs
  links_m <- links_m %>%
    mutate(
      IDsource = match(source, nodes_m$name) - 1,
      IDtarget = match(target, nodes_m$name) - 1)

  #9.2.4.2.7 Friendly label for this stratum
  mdd_label <- ifelse(strat == 1, "MDD+", "MDD−")
  cat("#### Sankey: BD NOS 00A→02A (", mdd_label, ")\n\n", sep = "")

  #9.2.4.2.8 Render the Sankey
  print(networkD3::sankeyNetwork(
    Links = links_m,
    Nodes = nodes_m,
    Source = "IDsource",
    Target = "IDtarget",
    Value = "value",
    NodeID = "name",
    fontSize = 10,
    nodeWidth = 30,
    sinksRight = FALSE))

  cat("\n\n")
}

```

In summary of the analysis of baseline & 2-year follow-up assessment timepoint BD NOS cases stratified by the presence of a GBI clinical cut-off score and/or MDD diagnosis: 

**Overall (unstratified) BD NOS Prevalence is inflated & rapidly changes across timepoints**

- KSADS v1.0 flags BD NOS in 8.3% of youth at baseline but only 3.6% two-years later. >90 % of baseline cases “drop out,” indicating low diagnostic stability rather than enduring morbidity (potentially - this could also jointly be a product of the fluctuation of BD symptoms over time)

**Symptom-based validators helps us detect a much more expected number of cases**

- Co-occurrence with a manic GBI score ≥ 12 is rare (0.3% at baseline, 0.1% at 2 yr)

- Co-occurrence with a lifetime MDD diagnosis is slightly higher (0.8% → 0.4%), but still represents <10 % of all NOS calls

- To note, fewer than 0.1% (n=3) of youth meet both lifetime validators (GBI≥12 + MDD) simultaneously

**Validators do not show a markedly different picture of diagnostic stability (for better or worse)**

- Within our "validated" strata, ~91 % of NOS cases remit by 2-year, and new-onset rates remain modest

**Implications for analysis** 

- Restricting BD NOS at baseline/2-year to youth who also carry a lifetime MDD diagnosis sharply reduces over-diagnosis but still yields an unstable, small group

- Down-stream models should therefore a) focus on the validated BD-I/II definitions, and b) treat NOS cases conservatively, e.g., include only MDD-validated NOS

## 10. Operationalization of Outcome Variables

Below is the coding scheme we will carry forward into all survival, longitudinal, and sensitivity models.  Every choice is anchored to the empirical patterns uncovered in Sections 5-9 of the EDA (instability, site effects, validator yields)

### 10.1 Primary Bipolar‐Spectrum Outcomes (binary, per wave)

| Variable in models           | Coding rule (per wave)                                                                                                                        | Empirical rationale from EDA                                                                                                                                                       |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **BD-I**                     | KSADS-COMP “current” or “recent-past” BD-I and<br> if wave = Baseline (00A) or 2-year (02A) → must also meet any lifetime MDD flag | KSADS-1.0 over-endorsed “past mania” (Sec 5). Re-scoring with an MDD validator reduced spurious past-only cases from 13 → 0.2 % and produced stable prevalence across later waves. |
| **BD-II**                    | Analogous to BD-I rule using hypomania + MDD validator at 00A/02A                                                                             | Same inflation/instability pattern; MDD validation trimmed prevalence to realistic 0.1–0.4 %.                                                                                      |
| **BD-NOS / Other Specified** | KSADS algorithm at Y4+ (v2.0) as is.<br>At 00A/02A (v1.0) retain only cases with lifetime MDD (no GBI requirement)                      | Only 0.8 % of youth meet NOS + MDD vs 8.3 % raw NOS (Sec 9). Validators still show >90 % remitting → keep but treat cautiously.                                                    |
| **Any BSD**                  | 1 if BD-I or BD-II or NOS (as defined above)                                                                                          | Captures full spectrum while excluding invalidated false-positives.                                                                                                                |

*Informant logic*: parent *or* youth endorsement = 1 (maximizes sensitivity; parent-only and “double-endorsement” rules will be sensitivity analyses)

### 10.2 Suicidality Outcomes (binary, per wave; scored **only among Any BSD**)

- **Passive SI**: any passive ideation flag (past or current)

- **Active SI**: any active ideation flag (method / intent / plan; past or current)

- **Suicide Attempt**: interrupted, aborted, or actual attempt (past or current)

- **NSSI**: non-suicidal self-injury (past or current)

*Why restricted to BSD*: keeps interpretation within a bipolar context; Section 6 showed extremely low BSD persistence, so suicidality is analysed at the same time rather than as lifetime carry-forward

### 10.3 Secondary Symptom Outcomes (continuous)

- CBCL DSM-5 Depression T, Anxiety T, Attention T, Aggression T

- Raw T-scores used; LMM residuals will be inspected and √/log transforms or gamma GLMMs deployed if required (EDA sec 3)

### 10.4 Sensitivity Analyses Already Planned

| Analysis                                    | Definition tested                         | Justification                                                        |
| ------------------------------------------- | ----------------------------------------- | -------------------------------------------------------------------- |
| **Tiered CBCL/GBI “risk” tiers**            | Tiers 1–4 from EDA §8                     | Extremely rare (<1 %) & unstable; included only as robustness check. |
| **Parent-only vs dual-informant diagnoses** | Re-score BD-I/II using parent flags alone | Evaluates impact of informant source.                                |
| **Exclude NOS entirely**                    | Run primary models on BD-I + BD-II only   | Sec 9 showed NOS inflation & instability.                            |

### 10.5 Modelling Framework (brief)

- **Discrete-time survival** for first incident BD-I, BD-II, Any BSD, SI, SA, NSSI starting Year-2; prevalent baseline cases removed from risk set but covaried

- **Wave‐specific mixed-effects prevalence** (BD & suicidality), random intercepts for participant & family

- **CBCL mixed models** for symptom severity trajectories

Covariates will include: sex, age (time-varying), clustering solution, baseline diagnosis where relevant, family ID random effect, assessment site (possible random effect if model convergence allows)
