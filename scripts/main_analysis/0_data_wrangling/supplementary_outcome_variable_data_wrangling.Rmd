---
title: "Supplementary Outcome Variables: Umbrella Dx + 4-Group Dx Variable"
author: "Sam A. Sievertsen"
output:
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    number_sections: false
    df_print: paged
---

```{r global, include = FALSE}

# Set global env variables
knitr::opts_chunk$set(cache = FALSE, message = TRUE, warning = TRUE, results = "markup", verbose = TRUE, comment = "")

```

```{r environment, echo = FALSE, message = FALSE, warning = FALSE}

# Load packages
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(skimr)
library(ggplot2)

# Set env options
options(scipen = 999, digits = 8)
set.seed(123)

# Paths
raw_path <- "../../../data/data_raw/dataset.csv"
outcome_path <- "../../../data/data_processed/outcome_variable_data.csv"
out_path <- "../../../data/data_processed/supplementary_outcome_variable_data.csv"

# Read in raw data
raw_data <- read.csv(raw_path)

# Assess whether previous outcome data exists
if (!file.exists(outcome_path)) {
  stop(
    "Missing file: data/data_processed/outcome_variable_data.csv\n",
    "Run outcome_variable_data_wrangling.Rmd first so we can merge validated any_bsd, etc.")
}

# Read in validated BD/SI outcomes generated by outcome_variable_data_wrangling.Rmd
outcome_data <- read.csv(outcome_path)

# Merge previously generated outcomes into the raw dataset
dat <- raw_data %>%
  left_join(outcome_data, by = c("participant_id", "session_id"))

```

## Overview

This script:

1.  Normalizes KSADS dx coding for the *new* raw diagnosis columns (888 -> 0; 555/999/""/NA -> NA)

2.  Creates umbrella (Sub_Domain) dx variables (0/1/NA) for conditions commonly co morbid with bipolar disorder (BD). Specifically:

    -   ADHD
    -   GAD
    -   Social Anxiety
    -   Separation Anxiety
    -   Panic Disorder
    -   OCD,
    -   DMDD
    -   MDD
    -   PDD
    -   PTSD
    -   ODD
    -   Conduct Disorder

3.  Creates a 4-group categorical variable at each session:

    1.  No Dx (in the dx set of interest)
    2.  BSD only
    3.  BSD + other Dx
    4.  Other Dx only (no BSD)

4.  Writes a single processed CSV containing all columns + new dx vars

## Define raw column sets for each umbrella diagnosis

```{r column mapping, echo = FALSE, warning = FALSE}

#2.1 ADHD (Parent)
adhd_vars <- c(
"mh_p_ksads__adhd__past_dx",
"mh_p_ksads__adhd__pres_dx",
"mh_p_ksads__adhd__partrem_dx",
"mh_p_ksads__adhd__unspec_dx",
"mh_p_ksads__adhd__oth_dx")

#2.2 GAD (Parent + Youth)
gad_vars <- c(
"mh_p_ksads__gad__past_dx",
"mh_p_ksads__gad__pres_dx",
"mh_y_ksads__gad__past_dx",
"mh_y_ksads__gad__pres_dx")

#2.3 Social Anxiety (Parent + Youth)
socanx_vars <- c(
"mh_p_ksads__socanx__past_dx",
"mh_p_ksads__socanx__pres_dx",
"mh_y_ksads__socanx__past_dx",
"mh_y_ksads__socanx__pres_dx")

#2.4 Separation Anxiety (Parent)
sepanx_vars <- c(
"mh_p_ksads__sepanx__past_dx",
"mh_p_ksads__sepanx__pres_dx")

#2.5 Panic Disorder (Parent + Youth)
panic_vars <- c(
"mh_p_ksads__panic__past_dx",
"mh_p_ksads__panic__pres_dx",
"mh_p_ksads__panic__partrem_dx",
"mh_y_ksads__panic__past_dx",
"mh_y_ksads__panic__pres_dx",
"mh_y_ksads__panic__partrem_dx")

#2.6 OCD (Parent + Youth)
ocd_vars <- c(
"mh_p_ksads__ocd__past_dx",
"mh_p_ksads__ocd__pres_dx",
"mh_y_ksads__ocd__past_dx",
"mh_y_ksads__ocd__pres_dx")

#2.7 DMDD (Parent + Youth; present only)
dmdd_vars <- c(
"mh_p_ksads__dmdd__dmdd__pres_dx",
"mh_y_ksads__dmdd__dmdd__pres_dx")

#2.8 MDD (Parent + Youth)
mdd_vars <- c(
"mh_p_ksads__dep__mdd__past_dx",
"mh_p_ksads__dep__mdd__pres_dx",
"mh_p_ksads__dep__mdd__partrem_dx",
"mh_y_ksads__dep__mdd__past_dx",
"mh_y_ksads__dep__mdd__pres_dx",
"mh_y_ksads__dep__mdd__partrem_dx")

#2.9 PDD / Dysthymia (Parent + Youth)
pdd_vars <- c(
"mh_p_ksads__dep__pdd__past_dx",
"mh_p_ksads__dep__pdd__pres_dx",
"mh_p_ksads__dep__pdd__partrem_dx",
"mh_y_ksads__dep__pdd__past_dx",
"mh_y_ksads__dep__pdd__pres_dx",
"mh_y_ksads__dep__pdd__partrem_dx")

#2.10 PTSD (Parent + Youth)
ptsd_vars <- c(
"mh_p_ksads__ptsd__past_dx",
"mh_p_ksads__ptsd__pres_dx",
"mh_p_ksads__ptsd__partrem_dx",
"mh_y_ksads__ptsd__past_dx",
"mh_y_ksads__ptsd__pres_dx",
"mh_y_ksads__ptsd__partrem_dx")

#2.11 ODD (Parent)
odd_vars <- c(
"mh_p_ksads__odd__past_dx",
"mh_p_ksads__odd__pres_dx")

#2.12 Conduct Disorder (Parent + Youth; adolescent onset + childhood onset)
cd_vars <- c(
"mh_p_ksads__cond__onset__adoles__past_dx",
"mh_p_ksads__cond__onset__adoles__pres_dx",
"mh_p_ksads__cond__onset__chld__past_dx",
"mh_p_ksads__cond__onset__chld__pres_dx",
"mh_y_ksads__cond__onset__adoles__past_dx",
"mh_y_ksads__cond__onset__adoles__pres_dx",
"mh_y_ksads__cond__onset__chld__past_dx",
"mh_y_ksads__cond__onset__chld__pres_dx")

#2.13 Collect all raw dx columns and sanity check existence
#2.13.1 Create a vector of the generated dx cols
dx_raw_cols <- unique(
  c(
    adhd_vars,
    gad_vars,
    socanx_vars,
    sepanx_vars,
    panic_vars,
    ocd_vars,
    dmdd_vars,
    mdd_vars,
    pdd_vars,
    ptsd_vars,
    odd_vars,
    cd_vars))

#2.13.2 Check whether any of the generated dx cols are missing necessary input cols
missing_cols <- setdiff(dx_raw_cols, names(dat))
if (length(missing_cols) > 0) {
  stop(
    "These expected KSADS dx columns are missing from dataset.csv:\n",
    paste0(" - ", missing_cols, collapse = "\n"))
}

```

## 3. Helper functions + code normalization

```{r helper functions, echo = FALSE, warning = FALSE}

#3.1 Normalize KSADS codes, where 888 (module not administered) -> 0; and 555 / 999 / "" / NA -> NA
normalize_ksads_dx <- function(x) {
  x <- suppressWarnings(as.numeric(x))
  dplyr::case_when(x == 888 ~ 0,
                   is.na(x) ~ NA_real_,
                   x %in% c(555, 999) ~ NA_real_,
                   TRUE ~ x)
}

#3.2 Build umbrella dx (1 if any raw ==1; 0 if all observed ==0; NA if all missing)
mk_umbrella_dx <- function(df, vars) {
  case_when(
    rowSums(dplyr::select(df, dplyr::all_of(vars)) == 1, na.rm = TRUE) > 0 ~ 1,
    rowSums(!is.na(dplyr::select(
      df, dplyr::all_of(vars)
    ))) == 0 ~ NA_real_,
    TRUE ~ 0)
}

```

## 4. Create umbrella dx variables + 4-group categorical variable

```{r create dx, echo = FALSE, warning = FALSE}

#4.1 Normalize raw dx columns in-place (processed file is allowed to deviate from raw)
dat2 <- dat %>%
  mutate(across(all_of(dx_raw_cols), ~ normalize_ksads_dx(.)))

#4.2 Create umbrella dx variables (0/1/NA)
dat2 <- dat2 %>%
  mutate(
    
    #4.2.1 Sub_Domain umbrella dx variables
    dx_adhd = mk_umbrella_dx(., adhd_vars),
    dx_gad = mk_umbrella_dx(., gad_vars),
    dx_socanx = mk_umbrella_dx(., socanx_vars),
    dx_sepanx = mk_umbrella_dx(., sepanx_vars),
    dx_panic = mk_umbrella_dx(., panic_vars),
    dx_ocd = mk_umbrella_dx(., ocd_vars),
    dx_dmdd = mk_umbrella_dx(., dmdd_vars),
    dx_mdd = mk_umbrella_dx(., mdd_vars),
    dx_pdd = mk_umbrella_dx(., pdd_vars),
    dx_ptsd = mk_umbrella_dx(., ptsd_vars),
    dx_odd = mk_umbrella_dx(., odd_vars),
    dx_cd = mk_umbrella_dx(., cd_vars))

#4.3 Any "other Dx of interest" composite (excluding BSD)
#4.3.1 Create a vector of the comorbidity dx
other_dx_umbrella_cols <- c(
  "dx_adhd",
  "dx_gad",
  "dx_socanx",
  "dx_sepanx",
  "dx_panic",
  "dx_ocd",
  "dx_dmdd",
  "dx_mdd",
  "dx_pdd",
  "dx_ptsd",
  "dx_odd",
  "dx_cd")

#4.3.2 Use the comorbidity vector to create the other dx of interest variable
dat2 <- dat2 %>%
  mutate(dx_other_any = case_when(
    rowSums(dplyr::select(., all_of(
      other_dx_umbrella_cols
    )) == 1, na.rm = TRUE) > 0 ~ 1,
    rowSums(!is.na(dplyr::select(
      ., all_of(other_dx_umbrella_cols)
    ))) == 0 ~ NA_real_,
    TRUE ~ 0))

#4.4 4-group categorical variable (uses validated any_bsd from outcome_variable_data.csv). If we can't determine BSD status or other-dx status -> NA
dat2 <- dat2 %>%
  mutate(
    dx_group4_code = case_when(
      any_bsd == 0 &
        dx_other_any == 0 ~ 1,
      
      #4.4.1 No Psych Dx (in dx set of interest)
      any_bsd == 1 & dx_other_any == 0 ~ 2,
      
      #4.4.2 BSD only
      any_bsd == 1 & dx_other_any == 1 ~ 3,
      
      #4.4.3 BSD + another Dx
      any_bsd == 0 & dx_other_any == 1 ~ 4,
      
      #4.4.4 Other Dx (no BSD)
      TRUE ~ NA_real_),
    dx_group4 = factor(
      dx_group4_code,
      levels = c(1, 2, 3, 4),
      labels = c(
        "No Dx (Dx-set of interest)",
        "BSD only",
        "BSD + other Dx",
        "Other Dx only (no BSD)"))
  )

```

## 5. Quick QC tables

```{r QC check, echo = FALSE, warning = FALSE}

#5.1 Sanity check of whether we have any_bsd
if (!("any_bsd" %in% names(dat2))) {
  stop(
    "any_bsd not present after merge. Check participant_id/session_id keys and outcome_variable_data.csv.")
}

#5.2 Prevalence by wave/session
#5.2.1 Log the prevalence of dx by wave
qc_by_wave <- dat2 %>%
  group_by(session_id) %>%
  summarise(
    n = n(),
    any_bsd_pct = mean(any_bsd == 1, na.rm = TRUE),
    other_dx_any_pct = mean(dx_other_any == 1, na.rm = TRUE),
    group4_na_pct = mean(is.na(dx_group4_code)),
    .groups = "drop")

#5.2.2 Print a kable outlining dx prevalence per wave
knitr::kable(qc_by_wave, caption = "QC: BSD / Other Dx / Group4 NA by Session", digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

#5.3 Group4 distribution by wave/session
#5.3.1 Log the composition of the 4 group categorical var by wave
group_dist <- dat2 %>%
  count(session_id, dx_group4) %>%
  group_by(session_id) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup()

#5.3.2 Pribt a kable outlining the composition of the 4 group categorical var by wave
knitr::kable(group_dist, caption = "QC: dx_group4 Distribution by Session", digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

#5.4 Skim just the derived columns
#5.4.1 Create a list of columns to check with skimr
derived_cols <- c(
  "participant_id",
  "session_id",
  other_dx_umbrella_cols,
  "dx_other_any",
  "any_bsd",
  "dx_group4_code",
  "dx_group4")

#5.4.2 Check relevant column distributions with skimr
suppressWarnings(skimr::skim_without_charts(dat2 %>% dplyr::select(any_of(derived_cols))))

#5.5 Join integrity checks (protect against unintended row duplication from the left_join)
#5.5.1 Check for duplicate keys in raw_data
raw_key_dups <- raw_data %>%
  count(participant_id, session_id) %>%
  filter(n > 1)

#5.5.2 Check for duplicate keys in outcome_data
outcome_key_dups <- outcome_data %>%
  count(participant_id, session_id) %>%
  filter(n > 1)

#5.5.3 Print diagnostics + hard-stop if join would expand rows
cat("\n#5.5 Join integrity\n")
cat("raw_data nrow:", nrow(raw_data), "\n")
cat("outcome_data nrow:", nrow(outcome_data), "\n")
cat("dat (joined) nrow:", nrow(dat), "\n\n")

#5.5.3.1 Print whether any subject IDs were duplicated in the merging process
if (nrow(outcome_key_dups) > 0) {
  cat("WARNING: Duplicate keys in outcome_data (showing first 10):\n")
  print(head(outcome_key_dups, 10))
}

#5.5.3.2 Print whether the number of rows in the merged data matches the number of rows in the raw data
if (nrow(dat) != nrow(raw_data)) {
  stop(
    "Join integrity failure: nrow(dat) != nrow(raw_data). This suggests a join expansion.\n",
    "Resolve duplicate (participant_id, session_id) keys before interpreting dx distributions."
  )
}

#5.6 Verify that dx mapping does not double-count any *raw* KSADS column across umbrellas
#5.6.1 Create a named mapping list of umbrella dx to raw columns
dx_map <- list(
  ADHD = adhd_vars,
  GAD = gad_vars,
  SOCANX = socanx_vars,
  SEPANX = sepanx_vars,
  PANIC = panic_vars,
  OCD = ocd_vars,
  DMDD = dmdd_vars,
  MDD = mdd_vars,
  PDD = pdd_vars,
  PTSD = ptsd_vars,
  ODD = odd_vars,
  CD = cd_vars)

#5.6.2 Identify any raw columns that appear in more than one umbrella list
raw_col_membership <- tibble(
  raw_col = unlist(dx_map),
  umbrella = rep(names(dx_map), lengths(dx_map))) %>%
  count(raw_col, name = "n_umbrellas") %>%
  dplyr::filter(n_umbrellas > 1)

#5.6.2.1 Print whether there were any variables that were used duplicatively
if (nrow(raw_col_membership) == 0) {
  cat("\n#5.6 Raw-column overlap check: PASS (no raw KSADS columns reused across umbrellas)\n")
} else {
  cat("\n#5.6 Raw-column overlap check: FAIL (raw columns reused across umbrellas)\n")
  print(raw_col_membership)
}

#5.7 Composition QC of how many + which umbrellas are driving dx_other_any and dx_group4
#5.7.1 Create per-row count of endorsed umbrella dx (among the 12 comorbidity umbrellas)
dat2 <- dat2 %>%
  mutate(
    dx_n_other = rowSums(dplyr::select(., all_of(other_dx_umbrella_cols)) == 1, na.rm = TRUE),
    dx_n_other_nonmiss = rowSums(!is.na(dplyr::select(., all_of(other_dx_umbrella_cols)))))

#5.7.2 Verify group logic has no internal contradictions
#       - "No Dx" + "BSD only" groups should have dx_n_other == 0 by construction
contradictions <- dat2 %>%
  filter(dx_group4 %in% c("No Dx (Dx-set of interest)", "BSD only")) %>%
  filter(dx_n_other > 0)

cat("\n#5.7 Group logic contradictions (should be 0 rows):", nrow(contradictions), "\n")
if (nrow(contradictions) > 0) {
  print(head(contradictions %>%
               select(participant_id, session_id, dx_group4, dx_n_other, all_of(other_dx_umbrella_cols)), 10))
}

#5.7.3 Table: overall umbrella dx prevalence by session (with denominators)
dx_prev_overall <- dat2 %>%
  select(session_id, all_of(other_dx_umbrella_cols)) %>%
  pivot_longer(cols = all_of(other_dx_umbrella_cols),
               names_to = "umbrella_dx",
               values_to = "val") %>%
  group_by(session_id, umbrella_dx) %>%
  summarise(
    n_nonmiss = sum(!is.na(val)),
    n_yes = sum(val == 1, na.rm = TRUE),
    pct_yes = if_else(n_nonmiss > 0, n_yes / n_nonmiss, NA_real_),
    .groups = "drop") %>%
  arrange(session_id, desc(pct_yes))

knitr::kable(
  dx_prev_overall,
  caption = "QC: Umbrella Dx Prevalence by Session (overall; denominators exclude NA)",
  digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

#5.7.4 Table: umbrella dx prevalence within dx_group4 strata (focus on strata where other dx should exist)
dx_prev_by_group <- dat2 %>%
  filter(dx_group4 %in% c("BSD + other Dx", "Other Dx only (no BSD)")) %>%
  select(session_id, dx_group4, all_of(other_dx_umbrella_cols)) %>%
  pivot_longer(cols = all_of(other_dx_umbrella_cols),
               names_to = "umbrella_dx",
               values_to = "val") %>%
  group_by(session_id, dx_group4, umbrella_dx) %>%
  summarise(
    n_nonmiss = sum(!is.na(val)),
    n_yes = sum(val == 1, na.rm = TRUE),
    pct_yes = if_else(n_nonmiss > 0, n_yes / n_nonmiss, NA_real_),
    .groups = "drop") %>%
  arrange(session_id, dx_group4, desc(pct_yes))

knitr::kable(
  dx_prev_by_group,
  caption = "QC: Umbrella Dx Prevalence by Session within Other-Dx Strata (denominators exclude NA)",
  digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

#5.7.5 Table: distribution of number of comorbidity umbrellas endorsed (dx_n_other) by session + dx_group4
dx_count_dist <- dat2 %>%
  filter(dx_group4 %in% c("BSD + other Dx", "Other Dx only (no BSD)")) %>%
  group_by(session_id, dx_group4, dx_n_other) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(session_id, dx_group4) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup()

knitr::kable(dx_count_dist, caption = "QC: Number of Umbrella Dx Endorsed among Other-Dx Strata", digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

#5.7.6 Plot: umbrella dx prevalence within the two “other dx present” strata, faceted by session (this is the direct "what’s driving dx_other_any" visual)
dx_prev_plot_dat <- dx_prev_by_group %>%
  mutate(pct_yes = pct_yes * 100)

ggplot(dx_prev_plot_dat, aes(x = umbrella_dx, y = pct_yes)) +
  geom_col() +
  coord_flip() +
  facet_grid(dx_group4 ~ session_id) +
  labs(
    title = "Umbrella Dx Prevalence within Other-Dx Strata (by Session)",
    x = "Umbrella Dx",
    y = "Percent endorsed (among non-missing)")


```

## 6. Write supplementary processed dataset

```{r write data, echo = FALSE, warning = FALSE}

#6.1 Only retain essential columns for the supplementary analysis
supplementary_outcome_data <- dat2 %>% 
  dplyr::select(participant_id, session_id, ab_g_dyn__design_site, ab_g_dyn__visit_age, ab_g_stc__cohort_ethnrace__meim, ab_g_stc__cohort_sex, ab_g_stc__design_id__fam, si_passive, si_active, sa, nssi, bipolar_I, bipolar_II, bd_nos, any_bsd, dx_adhd, dx_gad, dx_socanx, dx_sepanx, dx_panic, dx_ocd, dx_dmdd, dx_mdd, dx_pdd, dx_ptsd, dx_odd, dx_cd, dx_other_any, dx_group4_code, dx_group4)

#6.2 Write the full dataset (raw + validated outcomes + derived dx vars)
write.csv(supplementary_outcome_data, out_path, row.names = FALSE)

#6.3 Print that the dataset was written and where
cat("Wrote:", out_path, "\n")

```
